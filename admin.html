<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - VinoElite</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- GLOBAL STYLES --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        :root { --primary-color: #c19a6b; --primary-dark: #a67c52; --primary-light: #e8c8a0; --bg-dark: #1a1a1a; --bg-darker: #0f0f0f; --bg-light: #2d1b1b; --text-light: #f5f5f5; --text-muted: #b0b0b0; --border-color: rgba(255, 255, 255, 0.1); --success-color: #28a745; --warning-color: #ffc107; --danger-color: #dc3545; }
        html, body { height: 100%; }
        body { background: linear-gradient(135deg, var(--bg-dark) 0%, var(--bg-light) 100%); color: var(--text-light); line-height: 1.6; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        button, .btn { cursor: pointer; transition: all 0.3s ease; }

        /* === START: HEADER & FOOTER STYLES (Unified with Catalog) === */
        header { background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(10px); padding: 15px 0; position: sticky; top: 0; z-index: 100; border-bottom: 1px solid var(--border-color); height: 75px; }
        .header-content { display: flex; justify-content: space-between; align-items: center; height: 100%; }
        .logo { font-size: 1.8rem; font-weight: 300; letter-spacing: 2px; color: var(--primary-light); text-decoration: none; }
        .logo span { font-weight: 600; }
        .nav-links { display: flex; gap: 30px; }
        .nav-links a { color: var(--text-light); text-decoration: none; font-size: 0.9rem; letter-spacing: 1px; transition: color 0.3s ease; position: relative; padding: 5px 0; }
        .nav-links a::after { content: ''; position: absolute; bottom: -5px; left: 0; width: 0; height: 2px; background: var(--primary-color); transition: width 0.3s ease; }
        .nav-links a:hover::after, .nav-links a.active::after { width: 100%; }
        .nav-links a:hover, .nav-links a.active { color: var(--primary-light); }
        .header-actions { display: flex; gap: 15px; align-items: center; }
        .search-btn, .wishlist-btn, .cart-btn { position: relative; background: none; border: none; color: var(--text-light); font-size: 1.2rem; padding: 8px 12px; transition: all 0.3s ease; cursor: pointer; border-radius: 8px; text-decoration: none; }
        .search-btn:hover, .wishlist-btn:hover, .cart-btn:hover { color: var(--primary-light); background: rgba(255, 255, 255, 0.05); }
        .cart-count-badge, .wishlist-count-badge { position: absolute; top: 5px; right: 5px; background: var(--primary-color); color: var(--bg-dark); border-radius: 50%; width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: 600; line-height: 1; display: none; }
        .auth-btn { display: flex; align-items: center; gap: 8px; background: rgba(255, 255, 255, 0.1); color: var(--text-light); text-decoration: none; padding: 8px 16px; border-radius: 20px; border: 1px solid var(--border-color); font-size: 0.9rem; transition: all 0.3s ease; backdrop-filter: blur(10px); }
        .auth-btn:hover { background: var(--primary-color); color: var(--bg-dark); border-color: var(--primary-color); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(193, 154, 107, 0.3); }
        .mobile-actions { display: none; margin-top: 25px; padding-top: 25px; border-top: 1px solid var(--border-color); }
        .mobile-search { margin-bottom: 20px; }
        .search-box { display: flex; background: rgba(255, 255, 255, 0.05); border-radius: 25px; padding: 5px; border: 1px solid var(--border-color); }
        .search-box input { flex-grow: 1; background: none; border: none; color: var(--text-light); padding: 12px 15px; font-size: 1rem; }
        .search-box input::placeholder { color: var(--text-muted); }
        .search-box button { background: var(--primary-color); border: none; border-radius: 50%; width: 45px; height: 45px; color: var(--bg-dark); cursor: pointer; transition: all 0.3s ease; }
        .search-box button:hover { background: var(--primary-light); }
        .mobile-action-btn { display: flex; align-items: center; gap: 15px; color: var(--text-light); text-decoration: none; padding: 15px; border-radius: 10px; background: rgba(255, 255, 255, 0.03); margin-bottom: 8px; transition: all 0.3s ease; border: 1px solid transparent; }
        .mobile-action-btn:hover { background: rgba(255, 255, 255, 0.08); border-color: var(--border-color); transform: translateX(5px); }
        .mobile-action-btn i { width: 20px; text-align: center; font-size: 1.1rem; }
        .mobile-action-btn .cart-count, .mobile-action-btn .wishlist-count { background: var(--primary-color); color: var(--bg-dark); border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: 600; margin-left: auto; display: none; }
        .mobile-menu-btn { display: none; background: none; border: none; color: var(--text-light); font-size: 1.5rem; cursor: pointer; z-index: 1001; }

        footer { background: var(--bg-darker); padding: 60px 0 30px; border-top: 1px solid var(--border-color); }
        .footer-content { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 40px; margin-bottom: 40px; }
        .footer-column h3 { font-size: 1.2rem; margin-bottom: 20px; font-weight: 400; color: var(--primary-light); }
        .footer-links { list-style: none; }
        .footer-links li { margin-bottom: 10px; }
        .footer-links a { color: var(--text-muted); text-decoration: none; transition: color 0.3s ease; }
        .footer-links a:hover { color: var(--primary-light); }
        .social-links { display: flex; gap: 15px; margin-top: 20px; }
        .social-links a { display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; background: rgba(255, 255, 255, 0.1); border-radius: 50%; color: var(--text-light); text-decoration: none; transition: all 0.3s ease; }
        .social-links a:hover { background: var(--primary-color); color: var(--bg-dark); transform: translateY(-3px); }
        .footer-bottom { text-align: center; padding-top: 30px; border-top: 1px solid var(--border-color); color: var(--text-muted); font-size: 0.9rem; }
        /* === END: HEADER & FOOTER STYLES === */

        /* --- Search Modal --- */
        .search-modal { display: none; position: fixed; z-index: 1002; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); backdrop-filter: blur(5px); }
        .search-modal-content { position: relative; top: 25%; margin: 0 auto; width: 90%; max-width: 600px; }
        .search-modal .search-box { display: flex; background: rgba(255, 255, 255, 0.05); border-radius: 50px; padding: 8px; border: 1px solid var(--border-color); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .search-modal .search-box input { flex-grow: 1; background: none; border: none; color: var(--text-light); padding: 15px 25px; font-size: 1.2rem; }
        .search-modal .search-box input::placeholder { color: var(--text-muted); }
        .search-modal .search-box button { background: var(--primary-color); border: none; border-radius: 50%; width: 55px; height: 55px; font-size: 1.2rem; color: var(--bg-dark); cursor: pointer; transition: all 0.3s ease; }
        .search-modal .search-box button:hover { background: var(--primary-light); }
        .close-search-modal-btn { position: absolute; top: -50px; right: 0; color: var(--text-muted); font-size: 2.5rem; font-weight: bold; background: none; border: none; cursor: pointer; transition: color 0.3s ease; }
        .close-search-modal-btn:hover { color: var(--text-light); }

        /* --- ADMIN PANEL STYLES --- */
        .admin-section { padding: 20px 0; }
        .admin-container { display: flex; gap: 25px; }
        .admin-sidebar { width: 280px; flex-shrink: 0; background: rgba(255, 255, 255, 0.05); border-radius: 15px; padding: 20px; border: 1px solid var(--border-color); position: sticky; top: 95px; }
        .admin-main-content { flex: 1; background: rgba(255, 255, 255, 0.05); border-radius: 15px; padding: 25px; border: 1px solid var(--border-color); }
        
        .admin-user-info { display: flex; align-items: center; gap: 15px; margin-bottom: 25px; padding-bottom: 20px; border-bottom: 1px solid var(--border-color); }
        .admin-user-avatar { width: 50px; height: 50px; border-radius: 50%; background: var(--primary-color); display: flex; align-items: center; justify-content: center; font-size: 1.2rem; color: var(--bg-dark); font-weight: 600; }
        .admin-user-details h3 { font-size: 1.1rem; margin-bottom: 5px; font-weight: 500; }
        .admin-user-details p { color: var(--text-muted); font-size: 0.9rem; }
        .admin-menu { list-style: none; margin-bottom: 20px; }
        .admin-menu li { margin-bottom: 5px; }
        .admin-menu a { display: flex; align-items: center; gap: 12px; padding: 12px 15px; color: var(--text-light); text-decoration: none; border-radius: 8px; transition: all 0.3s ease; }
        .admin-menu a:hover, .admin-menu a.active { background: var(--primary-color); color: var(--bg-dark); }
        .admin-menu a i { width: 20px; text-align: center; }
        .exit-admin-btn { display: flex; align-items: center; gap: 12px; width: 100%; background: none; border: 1px solid var(--danger-color); color: var(--danger-color); padding: 12px 15px; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; font-size: 1rem; }
        .exit-admin-btn:hover { background: var(--danger-color); color: var(--text-light); }
        
        .admin-view { display: none; }
        .admin-view.active { display: block; }
        .admin-view h2 { font-size: 1.5rem; margin-bottom: 20px; font-weight: 400; color: var(--primary-light); border-bottom: 1px solid var(--border-color); padding-bottom: 15px; }
        .admin-view h3 { font-size: 1.3rem; font-weight: 400; color: var(--primary-light); margin: 25px 0 15px; }
        .admin-view h4 { font-size: 1.1rem; font-weight: 400; color: var(--primary-light); margin: 20px 0 15px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: var(--text-muted); }
        .form-group input, .form-group textarea, .form-group select { width: 100%; background: rgba(0, 0, 0, 0.2); border: 1px solid var(--border-color); color: var(--text-light); padding: 12px; border-radius: 8px; font-size: 1rem; }
        .form-group textarea { min-height: 120px; resize: vertical; }
        .form-group small { display: block; margin-top: 5px; color: var(--text-muted); font-size: 0.8rem; }
        .form-row { display: flex; gap: 15px; }
        .btn-save { background: var(--success-color); color: white; border: none; padding: 12px 25px; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; width: 100%; }
        .btn-save:hover { background: #218838; transform: translateY(-2px); }
        .btn-add-new { background: var(--primary-color); color: var(--bg-dark); border: none; padding: 12px 20px; border-radius: 8px; font-size: 0.95rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; margin-bottom: 20px; }
        .btn-add-new:hover { background: var(--primary-light); transform: translateY(-2px); }
        .form-section { background: rgba(255, 255, 255, 0.03); border-radius: 10px; padding: 20px; margin-bottom: 25px; border: 1px solid var(--border-color); }
        
        /* Table Styles */
        .reviews-table-wrapper { overflow-x: auto; margin-top: 20px; }
        .prepared-table { width: 100%; border-collapse: collapse; min-width: 950px; }
        .prepared-table th, .prepared-table td { border: 1px solid var(--border-color); padding: 12px 15px; vertical-align: middle; white-space: nowrap; }
        .prepared-table th { background-color: rgba(25, 25, 25, 0.8); backdrop-filter: blur(5px); font-weight: 500; color: var(--primary-light); position: sticky; top: 0; z-index: 1; }
        .prepared-table td.comment-cell { white-space: normal; min-width: 250px; }
        .prepared-table td img { width: 50px; height: 50px; object-fit: cover; border-radius: 5px; }
        .product-link { color: var(--primary-light); text-decoration: none; font-weight: 500; transition: color 0.3s ease; }
        .product-link:hover { color: var(--primary-color); }
        .review-rating { color: var(--warning-color); }
        
        .actions-cell { display: flex; gap: 8px; align-items: center; }
        .actions-cell button { background: none; border: none; font-size: 1rem; padding: 6px; border-radius: 5px; cursor: pointer; transition: all 0.3s ease; }
        .btn-edit { color: var(--primary-light); background: rgba(193, 154, 107, 0.1); }
        .btn-edit:hover { background: var(--primary-color); color: var(--bg-dark); }
        .btn-archive { color: var(--warning-color); background: rgba(255, 193, 7, 0.1); }
        .btn-archive:hover { background: var(--warning-color); color: var(--bg-dark); }
        .btn-delete { color: var(--danger-color); background: rgba(220, 53, 69, 0.1); }
        .btn-delete:hover { background: var(--danger-color); color: var(--text-light); }
        .btn-restore { color: var(--success-color); background: rgba(40, 167, 69, 0.1); }
        .btn-restore:hover { background: var(--success-color); color: var(--text-light); }
        .archived-item { opacity: 0.5; }
        .archived-item td { text-decoration: line-through; }
        
        /* Status Badges */
        .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: 600; }
        .status-paid { background: var(--success-color); color: white; }
        .status-pending { background: var(--warning-color); color: black; }
        .status-collected { background: var(--primary-color); color: var(--bg-dark); }
        .status-delivered { background: #17a2b8; color: white; }
        .status-cancelled { background: var(--danger-color); color: white; }
        
        /* Modal Styles */
        .review-modal, .order-modal, .user-summary-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 1002; align-items: center; justify-content: center; padding: 20px; }
        .review-modal.active, .order-modal.active, .user-summary-modal.active { display: flex; }
        .review-modal-content, .order-modal-content, .user-summary-modal-content { background: var(--bg-dark); border-radius: 15px; padding: 30px; width: 100%; max-width: 600px; border: 1px solid var(--border-color); max-height: 90vh; overflow-y: auto; }
        .user-summary-modal-content { max-width: 800px; }
        .review-modal-header, .order-modal-header, .user-summary-modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .review-modal-header h3, .order-modal-header h3, .user-summary-modal-header h3 { font-size: 1.5rem; font-weight: 400; color: var(--primary-light); }
        .close-modal { background: none; border: none; color: var(--text-muted); font-size: 1.5rem; cursor: pointer; }
        .close-modal:hover { color: var(--text-light); }
        .star-rating { display: flex; flex-direction: row-reverse; justify-content: flex-end; gap: 5px; }
        .star-rating input[type="radio"] { display: none; }
        .star-rating label { font-size: 1.8rem; color: var(--text-muted); cursor: pointer; transition: color 0.2s; }
        .star-rating input[type="radio"]:checked ~ label, .star-rating label:hover, .star-rating label:hover ~ label { color: var(--warning-color); }
        .modal-actions { display: flex; gap: 15px; margin-top: 25px; }
        .btn-cancel { background: rgba(255, 255, 255, 0.1); color: var(--text-light); border: 1px solid var(--border-color); padding: 12px 25px; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; flex: 1; }
        .btn-cancel:hover { background: rgba(255, 255, 255, 0.2); }
        
        /* User Summary Tabs */
        .user-summary-tabs { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 20px; }
        .user-summary-tab { background: none; border: none; color: var(--text-muted); padding: 12px 20px; cursor: pointer; transition: all 0.3s ease; position: relative; }
        .user-summary-tab.active { color: var(--primary-light); }
        .user-summary-tab.active::after { content: ''; position: absolute; bottom: -1px; left: 0; width: 100%; height: 2px; background: var(--primary-color); }
        .user-summary-tab-content { display: none; }
        .user-summary-tab-content.active { display: block; }

        /* --- KYC STYLES --- */
        .kyc-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 1002; align-items: center; justify-content: center; padding: 20px; }
        .kyc-modal.active { display: flex; }
        .kyc-modal-content { background: var(--bg-dark); border-radius: 15px; padding: 30px; width: 100%; max-width: 900px; border: 1px solid var(--border-color); max-height: 90vh; overflow-y: auto; }
        .kyc-modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); }
        .kyc-modal-header h3 { font-size: 1.5rem; font-weight: 400; color: var(--primary-light); margin: 0; }
        .close-kyc-modal { background: none; border: none; color: var(--text-muted); font-size: 1.5rem; cursor: pointer; }
        .close-kyc-modal:hover { color: var(--text-light); }
        .kyc-actions-cell { display: flex; gap: 5px; align-items: center; flex-wrap: wrap; }
        .kyc-btn { background: none; border: none; font-size: 0.8rem; padding: 6px 10px; border-radius: 5px; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 5px; }
        .kyc-btn-orders { color: var(--primary-light); background: rgba(193, 154, 107, 0.1); }
        .kyc-btn-orders:hover { background: var(--primary-color); color: var(--bg-dark); }
        .kyc-btn-reviews { color: var(--warning-color); background: rgba(255, 193, 7, 0.1); }
        .kyc-btn-reviews:hover { background: var(--warning-color); color: var(--bg-dark); }
        .kyc-btn-cart { color: var(--success-color); background: rgba(40, 167, 69, 0.1); }
        .kyc-btn-cart:hover { background: var(--success-color); color: white; }
        .kyc-btn-wishlist { color: var(--danger-color); background: rgba(220, 53, 69, 0.1); }
        .kyc-btn-wishlist:hover { background: var(--danger-color); color: white; }
        .kyc-btn-address { color: #17a2b8; background: rgba(23, 162, 184, 0.1); }
        .kyc-btn-address:hover { background: #17a2b8; color: white; }
        
        /* --- TOAST STYLES --- */
        .toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 1050; display: flex; flex-direction: column; gap: 10px; }
        .toast { background-color: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); color: var(--text-light); padding: 15px 20px; border-radius: 8px; border: 1px solid var(--border-color); box-shadow: 0 5px 15px rgba(0,0,0,0.3); visibility: hidden; opacity: 0; transition: visibility 0s, opacity 0.5s, transform 0.5s; transform: translateY(20px); }
        .toast.show { visibility: visible; opacity: 1; transform: translateY(0); }
        .toast.success { border-left: 4px solid var(--success-color); }
        .toast.danger { border-left: 4px solid var(--danger-color); }
        .toast.info { border-left: 4px solid var(--primary-color); }
        
        /* --- DESKTOP TABLE SCROLL FIX --- */
        @media (min-width: 993px) {
            .admin-main-content {
                max-height: calc(100vh - 120px);
                overflow: hidden;
                display: flex;
                flex-direction: column;
            }
            
            .admin-view.active {
                display: flex;
                flex-direction: column;
                height: 100%;
                overflow: hidden;
            }

            /* FIX START: Allow Hero section to scroll vertically */
            #admin-view-hero.active {
                overflow-y: auto;
                display: block; 
            }
            /* FIX END */

            .admin-view h2 {
                position: sticky;
                top: 0;
                background: var(--bg-dark);
                z-index: 5;
                margin-top: 0;
            }

            .reviews-table-wrapper {
                overflow: auto; /* X and Y */
                flex: 1;
                margin-top: 20px;
                position: relative;
                border: 1px solid var(--border-color);
                border-radius: 8px;
                background: rgba(0, 0, 0, 0.2);
                max-height: none; /* Let flex handle height */
            }

            .prepared-table th {
                position: sticky;
                top: 0;
                z-index: 10;
                background-color: #1a1a1a; /* Solid color needed for sticky header */
                border-bottom: 2px solid var(--primary-color);
                backdrop-filter: none; /* Remove blur to avoid transparency issues */
            }
            
            /* Scrollbars */
            .reviews-table-wrapper::-webkit-scrollbar { height: 10px; width: 10px; }
            .reviews-table-wrapper::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.05); }
            .reviews-table-wrapper::-webkit-scrollbar-thumb { background: var(--primary-color); border-radius: 5px; }
            .reviews-table-wrapper::-webkit-scrollbar-thumb:hover { background: var(--primary-light); }
            
            #product-form-container {
                max-height: 60vh;
                overflow-y: auto;
                flex-shrink: 0;
            }
        }

        /* --- RESPONSIVE STYLES --- */
        @media (max-width: 992px) {
            .admin-container { flex-direction: column; }
            .admin-sidebar { width: 100%; position: static; }
        }
        
        @media (max-width: 768px) {
            .header-actions .desktop-only { display: none; }
            .header-actions { display: flex; gap: 0; }
            .nav-links.active .mobile-actions { display: block; }
            
            .nav-links {
                display: flex;
                flex-direction: column;
                position: fixed;
                top: 75px;
                left: 0;
                width: 100%;
                height: calc(100vh - 75px);
                background: rgba(10, 10, 10, 0.98);
                backdrop-filter: blur(20px);
                padding: 25px 20px;
                border-bottom: 1px solid var(--border-color);
                overflow-y: auto;
                gap: 0;
                transform: translateX(-100%);
                transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
                z-index: 999;
            }
            .nav-links.active { transform: translateX(0); }
            .nav-links a:not(.mobile-action-btn) {
                font-size: 1.1rem;
                padding: 15px 0;
                border-bottom: 1px solid var(--border-color);
                opacity: 0;
                transform: translateX(-20px);
                transition: all 0.3s ease;
            }
            .nav-links.active a:not(.mobile-action-btn) { opacity: 1; transform: translateX(0); }
            .nav-links.active a:not(.mobile-action-btn):nth-child(1) { transition-delay: 0.1s; }
            .nav-links.active a:not(.mobile-action-btn):nth-child(2) { transition-delay: 0.15s; }
            .nav-links.active a:not(.mobile-action-btn):nth-child(3) { transition-delay: 0.2s; }
            .nav-links.active a:not(.mobile-action-btn):nth-child(4) { transition-delay: 0.25s; }
            .nav-links.active a:not(.mobile-action-btn):nth-child(5) { transition-delay: 0.3s; }
            .mobile-menu-btn { display: block; }
            
            .form-row { flex-direction: column; }
            .btn-add-new { width: 100%; margin-bottom: 0; }
            .kyc-modal-content { padding: 20px; margin: 10px; }
            .kyc-actions-cell { flex-direction: column; align-items: stretch; }
            .kyc-btn { justify-content: center; }
        }
        @media (max-width: 480px) { .mobile-action-btn { padding: 12px 15px; font-size: 0.95rem; } .search-box input { padding: 10px 15px; font-size: 0.9rem; } }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <a href="/index.html" class="logo">Vino<span>Elite</span></a>
                <nav class="nav-links" id="main-nav">
                    <a href="/index.html">Home</a>
                    <a href="/catalog.html">Catalog</a>
                    <a href="#">Collections</a>
                    <a href="#">Wineries</a>
                    <a href="#">About Us</a>
                    <div class="mobile-actions">
                        <div class="mobile-search">
                            <form class="search-box">
                                <input type="text" placeholder="Search wines...">
                                <button type="submit"><i class="fas fa-search"></i></button>
                            </form>
                        </div>
                        <a href="/profile.html" class="mobile-action-btn" id="mobile-auth-button">
                            <i class="far fa-user"></i>
                            <span>Sign In / Register</span>
                        </a>
                        <a href="/cart.html" class="mobile-action-btn">
                            <i class="fas fa-shopping-cart"></i>
                            <span>Shopping Cart</span>
                            <span class="cart-count">0</span>
                        </a>
                        <a href="/profile.html#wishlist" class="mobile-action-btn">
                            <i class="far fa-heart"></i>
                            <span>Wishlist</span>
                            <span class="wishlist-count">0</span>
                        </a>
                    </div>
                </nav>
                <div class="header-actions">
                    <button class="search-btn desktop-only" title="Search"><i class="fas fa-search"></i></button>
                    <a href="/profile.html#wishlist" class="wishlist-btn desktop-only" title="Wishlist"><i class="far fa-heart"></i><span class="wishlist-count-badge">0</span></a>
                    <a href="/profile.html" class="auth-btn desktop-only" id="auth-button" title="Sign In"><i class="far fa-user"></i><span class="auth-text">Sign In</span></a>
                    <a href="/cart.html" class="cart-btn desktop-only" title="Cart"><i class="fas fa-shopping-cart"></i><span class="cart-count-badge">0</span></a>
                </div>
                <button class="mobile-menu-btn"><i class="fas fa-bars"></i></button>
            </div>
        </div>
    </header>

    <div class="admin-section container">
        <div class="admin-container">
            <aside class="admin-sidebar">
                <div class="admin-user-info">
                    <div class="admin-user-avatar">A</div>
                    <div class="admin-user-details">
                        <h3>Administrator</h3>
                        <p>VinoElite Admin</p>
                    </div>
                </div>
                
                <ul class="admin-menu">
                    <li><a href="#" data-view="hero" class="active"><i class="fas fa-image"></i> Hero Section</a></li>
                    <li><a href="#" data-view="categories"><i class="fas fa-tags"></i> Categories</a></li>
                    <li><a href="#" data-view="products"><i class="fas fa-wine-bottle"></i> Products</a></li>
                    <li><a href="#" data-view="reviews"><i class="fas fa-star"></i> Reviews</a></li>
                    <li><a href="#" data-view="users"><i class="fas fa-users"></i> Users</a></li>
                    <li><a href="#" data-view="kyc"><i class="fas fa-id-card"></i> KYC Overview</a></li>
                </ul>
                
                <a href="/index.html" class="exit-admin-btn">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Exit Admin Mode</span>
                </a>
            </aside>
            
            <main class="admin-main-content">
                <div id="admin-view-hero" class="admin-view active">
                    <h2>Edit Hero Section</h2>
                    <form id="hero-form">
                        <div class="form-section">
                            <h3>Hero Content</h3>
                            <div class="form-group"><label for="hero-subtitle">Subtitle</label><input type="text" id="hero-subtitle" name="heroSubtitle"></div>
                            <div class="form-group"><label for="hero-title">Title</label><input type="text" id="hero-title" name="heroTitle"></div>
                            <div class="form-group"><label for="hero-description">Description</label><textarea id="hero-description" name="heroDescription"></textarea></div>
                            <div class="form-group"><label for="hero-bg-image">Background Image URL</label><input type="text" id="hero-bg-image" name="heroBgImage"></div>
                        </div>
                        <div class="form-section">
                            <h3>SEO Settings</h3>
                            <div class="form-group"><label for="hero-meta-title">Meta Title</label><input type="text" id="hero-meta-title" name="metaTitle"></div>
                            <div class="form-group"><label for="hero-meta-description">Meta Description</label><textarea id="hero-meta-description" name="metaDescription"></textarea></div>
                        </div>
                        <button type="submit" class="btn-save">Save Changes</button>
                    </form>
                </div>
                
                <div id="admin-view-categories" class="admin-view">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; margin-bottom: 20px;">
                        <h2 style="margin: 0; border: none; padding: 0;">Manage Categories</h2>
                        <button id="btn-add-category" class="btn-add-new"><i class="fas fa-plus"></i> Add New Category</button>
                    </div>
                    <div id="category-form-container" class="form-section" style="display: none;">
                        <h3 id="category-form-title">Add New Category</h3>
                        <form id="category-form">
                            <input type="hidden" id="category-id" name="id">
                            <div class="form-group"><label for="category-name">Category Name</label><input type="text" id="category-name" name="name" required></div>
                            <div class="form-group"><label for="category-slug">URL Slug</label><input type="text" id="category-slug" name="slug" required><small>e.g., "Red Wine" -> "red-wine".</small></div>
                            <div class="form-group"><label for="category-image">Image URL</label><input type="text" id="category-image" name="imageUrl" required></div>
                            <div class="form-group"><label for="category-product-count">Product Count</label><input type="number" id="category-product-count" name="productCount" required></div>
                            
                            <div class="form-section" style="margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border-color);">
                                <h4>SEO Settings</h4>
                                <div class="form-group">
                                    <label for="category-meta-title">Meta Title</label>
                                    <input type="text" id="category-meta-title" name="metaTitle">
                                    <small>Optimal length: 50-60 characters. Displayed in the browser tab title and in Google search.</small>
                                </div>
                                <div class="form-group">
                                    <label for="category-meta-description">Meta Description</label>
                                    <textarea id="category-meta-description" name="metaDescription"></textarea>
                                    <small>Optimal length: 150-160 characters. Displayed under the title in Google search.</small>
                                </div>
                            </div>

                            <div style="display: flex; gap: 10px;"><button type="submit" class="btn-save">Save Category</button><button type="button" id="category-cancel-btn" class="btn-add-new" style="background: rgba(255,255,255,0.1); color: var(--text-light);">Cancel</button></div>
                        </form>
                    </div>
                    <div class="reviews-table-wrapper">
                        <table class="prepared-table">
                            <thead><tr><th>Image</th><th>Name</th><th>Slug</th><th>Status</th><th>Actions</th></tr></thead>
                            <tbody id="categories-table-body"></tbody>
                        </table>
                    </div>
                </div>
                
                <div id="admin-view-products" class="admin-view">
                     <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; margin-bottom: 20px;">
                        <h2 style="margin: 0; border: none; padding: 0;">Manage Products</h2>
                        <button id="btn-add-product" class="btn-add-new"><i class="fas fa-plus"></i> Add New Product</button>
                    </div>
                    <div id="product-form-container" class="form-section" style="display: none; max-height: 70vh; overflow-y: auto;">
                        <h3 id="product-form-title">Add New Product</h3>
                        <form id="product-form">
                            <input type="hidden" id="product-id" name="id">
                            <div class="form-section">
                                <h4>Main Information</h4>
                                <div class="form-group"><label for="product-name">Product Name</label><input type="text" id="product-name" name="name" required></div>
                                <div class="form-group"><label for="product-slug">URL Slug</label><input type="text" id="product-slug" name="slug" required></div>
                                <div class="form-row"><div class="form-group" style="flex: 1;"><label for="product-country">Country</label><input type="text" id="product-country" name="country" required></div><div class="form-group" style="flex: 1;"><label for="product-region">Region</label><input type="text" id="product-region" name="region" required></div></div>
                                <div class="form-group"><label for="product-appellation">Appellation</label><input type="text" id="product-appellation" name="appellation"></div>
                                <div class="form-row"><div class="form-group" style="flex: 1;"><label for="product-year">Year</label><input type="number" id="product-year" name="year"></div><div class="form-group" style="flex: 2;"><label for="product-grape-varieties">Grape Varieties</label><input type="text" id="product-grape-varieties" name="grapeVarieties"></div></div>
                                <div class="form-row"><div class="form-group" style="flex: 1;"><label for="product-sweetness">Sweetness</label><select id="product-sweetness" name="sweetness"><option value="">-- Select --</option><optgroup label="Still Wines"><option value="Dry">Dry</option><option value="Semi-Dry">Semi-Dry</option><option value="Semi-Sweet">Semi-Sweet</option><option value="Sweet">Sweet</option></optgroup><optgroup label="Sparkling Wines"><option value="Brut Nature">Brut Nature</option><option value="Extra Brut">Extra Brut</option><option value="Brut">Brut</option><option value="Extra-Dry">Extra-Dry</option><option value="Dry / Sec">Dry / Sec</option><option value="Demi-Sec">Demi-Sec</option><option value="Doux">Doux</option></optgroup></select></div><div class="form-group" style="flex: 1;"><label for="product-alcohol">Alcohol %</label><input type="number" id="product-alcohol" name="alcohol" step="0.1"></div></div>
                                <div class="form-row"><div class="form-group" style="flex: 1;"><label for="product-volume">Volume</label><select id="product-volume" name="volume"><option value="0.375L">0.375L</option><option value="0.75L">0.75L</option><option value="1.5L">1.5L</option></select></div><div class="form-group" style="flex: 1;"><label for="product-category">Category</label><select id="product-category" name="category" required></select></div></div>
                                <div class="form-group"><label for="product-image-urls">Image URLs (one per line)</label><textarea id="product-image-urls" name="imageUrls" required rows="4"></textarea></div>
                                <div class="form-group"><label for="product-description">Description</label><textarea id="product-description" name="description"></textarea></div>
                            </div>
                            <div class="form-section">
                                <h4>Pricing & Status</h4>
                                <div class="form-row"><div class="form-group" style="flex: 1;"><label for="product-price">Price</label><input type="number" id="product-price" name="price" step="0.01" required></div><div class="form-group" style="flex: 1;"><label for="product-old-price">Old Price</label><input type="number" id="product-old-price" name="oldPrice" step="0.01"></div></div>
                                <div class="form-row"><div class="form-group" style="flex: 1;"><label for="product-badge">Badge</label><input type="text" id="product-badge" name="badge"></div><div class="form-group" style="flex: 1;"><label for="product-stock-status">Stock Status</label><select id="product-stock-status" name="stockStatus"><option value="In Stock">In Stock</option><option value="Low Stock">Low Stock</option><option value="Out of Stock">Out of Stock</option></select></div></div>
                            </div>
                            <div class="form-section">
                                <h4>Wine Details</h4>
                                <div class="form-group"><label for="product-tasting-notes">Tasting Notes</label><textarea id="product-tasting-notes" name="tastingNotes"></textarea></div>
                                <div class="form-group"><label for="product-food-pairing">Food Pairing</label><textarea id="product-food-pairing" name="foodPairing"></textarea></div>
                                <div class="form-group"><label for="product-serving">Serving Recommendations</label><textarea id="product-serving" name="serving"></textarea></div>
                            </div>
                            <div class="form-section">
                                <h4>SEO & Schema Markup</h4>
                                <div class="form-group"><label for="product-meta-title">Meta Title</label><input type="text" id="product-meta-title" name="metaTitle"></div>
                                <div class="form-group"><label for="product-meta-description">Meta Description</label><textarea id="product-meta-description" name="metaDescription"></textarea></div>
                                <div class="form-row"><div class="form-group" style="flex: 1;"><label for="product-sku">SKU</label><input type="text" id="product-sku" name="sku"></div><div class="form-group" style="flex: 1;"><label for="product-brand">Producer / Winery</label><input type="text" id="product-brand" name="brand"></div></div>
                                <div class="form-row"><div class="form-group" style="flex: 1;"><label for="product-gtin">GTIN</label><input type="text" id="product-gtin" name="gtin"></div><div class="form-group" style="flex: 1;"><label for="product-rating-value">Average Rating (1-5)</label><input type="number" id="product-rating-value" name="ratingValue" step="0.1" min="1" max="5"></div></div>
                                <div class="form-group"><label for="product-review-count">Number of Reviews</label><input type="number" id="product-review-count" name="reviewCount" step="1" min="0"></div>
                            </div>
                            <div style="display: flex; gap: 10px;"><button type="submit" class="btn-save">Save Product</button><button type="button" id="product-cancel-btn" class="btn-add-new" style="background: rgba(255,255,255,0.1); color: var(--text-light);">Cancel</button></div>
                        </form>
                    </div>
                    <div class="reviews-table-wrapper">
                        <table class="prepared-table">
                            <thead><tr><th>Image</th><th>Name</th><th>Price</th><th>Status</th><th>Actions</th></tr></thead>
                            <tbody id="products-table-body"></tbody>
                        </table>
                    </div>
                </div>

                <div id="admin-view-reviews" class="admin-view">
                    <h2 style="border: none; padding-bottom: 0;">Manage Reviews</h2>
                    <div class="reviews-table-wrapper">
                        <table class="prepared-table">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Author</th>
                                    <th>Rating</th>
                                    <th>Review Title</th>
                                    <th>Comment</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="reviews-table-body"></tbody>
                        </table>
                    </div>
                </div>

                <div id="admin-view-users" class="admin-view">
                    <h2 style="border: none; padding-bottom: 0;">Manage Users</h2>
                    <div class="reviews-table-wrapper">
                        <table class="prepared-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Latest Order</th>
                                    <th>Order Status</th>
                                    <th>Customer Summary</th>
                                </tr>
                            </thead>
                            <tbody id="users-table-body">
                                <tr>
                                    <td>John Smith</td>
                                    <td>john.smith@example.com</td>
                                    <td>#ORD-001</td>
                                    <td>
                                        <select class="order-status-select" data-order-id="ORD-001">
                                            <option value="paid">Paid</option>
                                            <option value="collected" selected>Collected</option>
                                            <option value="delivered">Delivered</option>
                                            <option value="cancelled">Cancelled</option>
                                        </select>
                                    </td>
                                    <td class="actions-cell">
                                        <button class="btn-edit view-order-details" data-order-id="ORD-001"><i class="fas fa-eye"></i> View Order</button>
                                        <button class="btn-archive view-user-summary" data-user-id="user1"><i class="fas fa-chart-bar"></i> Summary</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>Maria Garcia</td>
                                    <td>maria.garcia@example.com</td>
                                    <td>#ORD-002</td>
                                    <td>
                                        <select class="order-status-select" data-order-id="ORD-002">
                                            <option value="paid" selected>Paid</option>
                                            <option value="collected">Collected</option>
                                            <option value="delivered">Delivered</option>
                                            <option value="cancelled">Cancelled</option>
                                        </select>
                                    </td>
                                    <td class="actions-cell">
                                        <button class="btn-edit view-order-details" data-order-id="ORD-002"><i class="fas fa-eye"></i> View Order</button>
                                        <button class="btn-archive view-user-summary" data-user-id="user2"><i class="fas fa-chart-bar"></i> Summary</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- KYC Section -->
                <div id="admin-view-kyc" class="admin-view">
                    <h2 style="border: none; padding-bottom: 0;">KYC - Customer Overview</h2>
                    <div class="reviews-table-wrapper">
                        <table class="prepared-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Total Orders</th>
                                    <th>Total Spent</th>
                                    <th>Last Activity</th>
                                    <th>Customer Details</th>
                                </tr>
                            </thead>
                            <tbody id="kyc-table-body">
                                <!-- Data will be loaded by KYCManager -->
                            </tbody>
                        </table>
                    </div>
                </div>

            </main>
        </div>
    </div>

    <footer id="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-column"><h3>VinoElite</h3><ul class="footer-links"><li><a href="#">About Us</a></li><li><a href="#">Contact</a></li><li><a href="#">Shipping & Payment</a></li><li><a href="#">Returns</a></li></ul></div>
                <div class="footer-column"><h3>Catalog</h3><ul class="footer-links"><li><a href="#">Red Wines</a></li><li><a href="#">White Wines</a></li><li><a href="#">Sparkling Wines</a></li><li><a href="#">Spirits</a></li></ul></div>
                <div class="footer-column"><h3>Help</h3><ul class="footer-links"><li><a href="#">FAQ</a></li><li><a href="#">Terms of Use</a></li><li><a href="#">Privacy Policy</a></li><li><a href="#">Sitemap</a></li></ul></div>
                <div class="footer-column"><h3>Contacts</h3><ul class="footer-links"><li><i class="fas fa-phone"></i> +7 (495) 123-45-67</li><li><i class="fas fa-envelope"></i> info@vinoelite.com</li><li><i class="fas fa-map-marker-alt"></i> Moscow, Vinaya St, 15</li></ul><div class="social-links"><a href="#"><i class="fab fa-instagram"></i></a><a href="#"><i class="fab fa-facebook-f"></i></a><a href="#"><i class="fab fa-telegram"></i></a><a href="#"><i class="fab fa-whatsapp"></i></a></div></div>
            </div>
            <div class="footer-bottom"><p>&copy; 2023 VinoElite. All rights reserved.</p></div>
        </div>
    </footer>

    <div id="search-modal" class="search-modal">
        <div class="search-modal-content">
            <button class="close-search-modal-btn">&times;</button>
            <form id="desktop-search-form" class="search-box">
                <input type="text" id="desktop-search-input" placeholder="Search for wines, regions, wineries...">
                <button type="submit"><i class="fas fa-search"></i></button>
            </form>
        </div>
    </div>

    <div class="toast-container" id="toast-container"></div>

    <!-- Review Modal -->
    <div class="review-modal" id="review-modal">
        <div class="review-modal-content">
            <div class="review-modal-header"><h3 id="review-modal-title">Edit Review</h3><button class="close-modal">&times;</button></div>
            <form id="review-form">
                <input type="hidden" id="review-id"><input type="hidden" id="review-product-id">
                <div class="form-group"><label>Rating</label><div class="star-rating"><input type="radio" id="star5" name="rating" value="5" required><label for="star5" title="5 stars">★</label><input type="radio" id="star4" name="rating" value="4"><label for="star4" title="4 stars">★</label><input type="radio" id="star3" name="rating" value="3"><label for="star3" title="3 stars">★</label><input type="radio" id="star2" name="rating" value="2"><label for="star2" title="2 stars">★</label><input type="radio" id="star1" name="rating" value="1"><label for="star1" title="1 star">★</label></div></div>
                <div class="form-group"><label for="review-title-input">Review Title</label><input type="text" id="review-title-input" required></div>
                <div class="form-group"><label for="review-comment-input">Comment</label><textarea id="review-comment-input" required></textarea></div>
                <div class="modal-actions"><button type="button" class="btn-cancel">Cancel</button><button type="submit" class="btn-save">Save Changes</button></div>
            </form>
        </div>
    </div>

    <!-- Order Details Modal -->
    <div class="order-modal" id="order-modal">
        <div class="order-modal-content">
            <div class="order-modal-header"><h3 id="order-modal-title">Order Details</h3><button class="close-modal">&times;</button></div>
            <div id="order-details-content"></div>
            <div class="modal-actions"><button type="button" class="btn-cancel">Close</button></div>
        </div>
    </div>

    <!-- User Summary Modal -->
    <div class="user-summary-modal" id="user-summary-modal">
        <div class="user-summary-modal-content">
            <div class="user-summary-modal-header"><h3 id="user-summary-modal-title">Customer Summary</h3><button class="close-modal">&times;</button></div>
            <div class="user-summary-tabs">
                <button class="user-summary-tab active" data-tab="orders">Orders</button>
                <button class="user-summary-tab" data-tab="wishlist">Wishlist</button>
                <button class="user-summary-tab" data-tab="reviews">Reviews</button>
                <button class="user-summary-tab" data-tab="cart">Cart</button>
            </div>
            <div class="user-summary-tab-content active" id="orders-tab">
                <h4>Order History</h4>
                <div class="reviews-table-wrapper"><table class="prepared-table"><thead><tr><th>Order ID</th><th>Date</th><th>Total</th><th>Status</th></tr></thead><tbody id="user-orders-table"></tbody></table></div>
            </div>
            <div class="user-summary-tab-content" id="wishlist-tab">
                <h4>Wishlist Items</h4>
                <div class="reviews-table-wrapper"><table class="prepared-table"><thead><tr><th>Product</th><th>Price</th><th>Added Date</th></tr></thead><tbody id="user-wishlist-table"></tbody></table></div>
            </div>
            <div class="user-summary-tab-content" id="reviews-tab">
                <h4>User Reviews</h4>
                <div class="reviews-table-wrapper"><table class="prepared-table"><thead><tr><th>Product</th><th>Rating</th><th>Review</th><th>Date</th></tr></thead><tbody id="user-reviews-table"></tbody></table></div>
            </div>
            <div class="user-summary-tab-content" id="cart-tab">
                <h4>Current Cart</h4>
                <div class="reviews-table-wrapper"><table class="prepared-table"><thead><tr><th>Product</th><th>Quantity</th><th>Price</th></tr></thead><tbody id="user-cart-table"></tbody></table></div>
            </div>
            <div class="modal-actions"><button type="button" class="btn-cancel">Close</button></div>
        </div>
    </div>

    <!-- KYC Modals -->
    <div class="kyc-modal" id="kyc-orders-modal"><div class="kyc-modal-content"><div class="kyc-modal-header"><h3>Order History</h3><button class="close-kyc-modal">&times;</button></div><div class="reviews-table-wrapper"><table class="prepared-table"><thead><tr><th>Order ID</th><th>Date</th><th>Items</th><th>Total</th><th>Status</th><th>Details</th></tr></thead><tbody></tbody></table></div><div class="modal-actions"><button type="button" class="btn-cancel">Close</button></div></div></div>
    <div class="kyc-modal" id="kyc-reviews-modal"><div class="kyc-modal-content"><div class="kyc-modal-header"><h3>Customer Reviews</h3><button class="close-kyc-modal">&times;</button></div><div class="reviews-table-wrapper"><table class="prepared-table"><thead><tr><th>Product</th><th>Rating</th><th>Review Title</th><th>Comment</th><th>Date</th></tr></thead><tbody></tbody></table></div><div class="modal-actions"><button type="button" class="btn-cancel">Close</button></div></div></div>
    <div class="kyc-modal" id="kyc-cart-modal"><div class="kyc-modal-content"><div class="kyc-modal-header"><h3>Current Cart</h3><button class="close-kyc-modal">&times;</button></div><div class="reviews-table-wrapper"><table class="prepared-table"><thead><tr><th>Product</th><th>Quantity</th><th>Price</th><th>Total</th></tr></thead><tbody></tbody></table></div><div class="form-section" style="margin-top: 20px;"></div><div class="modal-actions"><button type="button" class="btn-cancel">Close</button></div></div></div>
    <div class="kyc-modal" id="kyc-wishlist-modal"><div class="kyc-modal-content"><div class="kyc-modal-header"><h3>Wishlist</h3><button class="close-kyc-modal">&times;</button></div><div class="reviews-table-wrapper"><table class="prepared-table"><thead><tr><th>Product</th><th>Price</th><th>Category</th><th>Added Date</th></tr></thead><tbody></tbody></table></div><div class="modal-actions"><button type="button" class="btn-cancel">Close</button></div></div></div>
    <div class="kyc-modal" id="kyc-address-modal"><div class="kyc-modal-content"><div class="kyc-modal-header"><h3>Delivery Address</h3><button class="close-kyc-modal">&times;</button></div><div class="form-section primary-address-container"></div><div class="form-section"><h4>Alternative Addresses</h4><div class="reviews-table-wrapper"><table class="prepared-table"><thead><tr><th>Type</th><th>Address</th><th>City</th><th>Default</th></tr></thead><tbody></tbody></table></div></div><div class="modal-actions"><button type="button" class="btn-cancel">Close</button></div></div></div>
    <div class="kyc-modal" id="order-full-details-modal"><div class="kyc-modal-content"><div class="kyc-modal-header"><h3>Order Details</h3><button class="close-kyc-modal">&times;</button></div><div class="form-section"><h4>Order Information</h4><div class="form-row"></div></div><div class="form-section"><h4>Customer Information</h4><div class="form-row"></div></div><div class="form-section"><h4>Order Items</h4><div class="reviews-table-wrapper"><table class="prepared-table"><thead><tr><th>Product</th><th>SKU</th><th>Quantity</th><th>Unit Price</th><th>Total</th></tr></thead><tbody></tbody></table></div></div><div class="form-section"><h4>Order Summary</h4><div class="form-row"></div></div><div class="form-section"><h4>Shipping Information</h4></div><div class="modal-actions"><button type="button" class="btn-cancel">Close</button></div></div></div>

    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, getDoc, query, where, addDoc, updateDoc, deleteDoc, collectionGroup, runTransaction, limit } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";

    const firebaseConfig = { apiKey: "AIzaSyBflzOWVf3HgDpdUhha3qvyeUJf7i6dOuk", authDomain: "wine-91d0e.firebaseapp.com", projectId: "wine-91d0e", storageBucket: "wine-91d0e.firebasestorage.app", messagingSenderId: "1021620433427", appId: "1:1021620433427:web:5439252fb350c4455a85e6", measurementId: "G-TRWHY3KXK1" };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    function showToast(message, type = 'info') { const container = document.getElementById('toast-container'); const toast = document.createElement('div'); toast.className = `toast ${type}`; toast.textContent = message; container.appendChild(toast); setTimeout(() => toast.classList.add('show'), 10); setTimeout(() => { toast.classList.remove('show'); toast.addEventListener('transitionend', () => toast.remove()); }, 3000); }

    document.addEventListener('DOMContentLoaded', () => {
        let localData = { hero: {}, categories: [], products: [], reviews: [], users: [] };

        // --- START: HEADER COUNTERS & AUTH LOGIC ---
        const CART_STORAGE_KEY = 'vinoelite_cart';
        const WISHLIST_STORAGE_KEY = 'vinoelite_wishlist';
        let wishlistProductIds = new Set();

        async function updateHeaderCounters() {
            const user = auth.currentUser;
            let cartItemCount = 0;
            let wishlistItemCount = 0;
            if (user) {
                const cartSnapshot = await getDocs(collection(db, `users/${user.uid}/cart`));
                cartSnapshot.forEach(doc => { cartItemCount += doc.data().quantity; });
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (userDoc.exists() && userDoc.data().wishlist) {
                    wishlistItemCount = userDoc.data().wishlist.length;
                    wishlistProductIds = new Set(userDoc.data().wishlist);
                }
            } else {
                const localCart = JSON.parse(localStorage.getItem(CART_STORAGE_KEY)) || [];
                localCart.forEach(item => { cartItemCount += item.quantity; });
                const localWishlist = JSON.parse(localStorage.getItem(WISHLIST_STORAGE_KEY)) || [];
                wishlistItemCount = localWishlist.length;
                wishlistProductIds = new Set(localWishlist);
            }
            document.querySelectorAll('.cart-count, .cart-count-badge').forEach(el => {
                el.textContent = cartItemCount;
                el.style.display = cartItemCount > 0 ? 'flex' : 'none';
            });
            document.querySelectorAll('.wishlist-count, .wishlist-count-badge').forEach(el => {
                el.textContent = wishlistItemCount;
                el.style.display = wishlistItemCount > 0 ? 'flex' : 'none';
            });
        }

        const mobileMenuBtn = document.querySelector('.mobile-menu-btn');
        const navLinks = document.getElementById('main-nav');
        mobileMenuBtn.addEventListener('click', () => {
            const isActive = navLinks.classList.toggle('active');
            mobileMenuBtn.classList.toggle('active', isActive);
            mobileMenuBtn.innerHTML = isActive ? '<i class="fas fa-times"></i>' : '<i class="fas fa-bars"></i>';
        });

        function updateUIForAuthState(user) {
            const desktopAuthBtn = document.getElementById('auth-button');
            const mobileAuthBtn = document.getElementById('mobile-auth-button');
            if (user) {
                const userName = user.displayName || user.email.split('@')[0];
                desktopAuthBtn.innerHTML = `<i class="fas fa-user-check"></i> <span class="auth-text">${userName}</span>`;
                desktopAuthBtn.title = "My Account";
                desktopAuthBtn.removeEventListener('click', openLoginModal);
                mobileAuthBtn.href = "/profile.html";
                mobileAuthBtn.querySelector('span').textContent = userName;
                mobileAuthBtn.removeEventListener('click', openLoginModal);
            } else {
                desktopAuthBtn.href = "#";
                desktopAuthBtn.innerHTML = `<i class="far fa-user"></i> <span class="auth-text">Sign In</span>`;
                desktopAuthBtn.title = "Sign In";
                desktopAuthBtn.addEventListener('click', openLoginModal);
                mobileAuthBtn.href = "#";
                mobileAuthBtn.querySelector('span').textContent = 'Sign In / Register';
                mobileAuthBtn.addEventListener('click', openLoginModal);
            }
        }

        function openLoginModal(e) { 
            e.preventDefault(); 
            showToast('Please use the main site to log in', 'info');
        }

        onAuthStateChanged(auth, async (user) => { 
            updateUIForAuthState(user); 
            await updateHeaderCounters();
        });
        
        const desktopSearchBtn = document.querySelector('.search-btn.desktop-only');
        const searchModal = document.getElementById('search-modal');
        const closeSearchModalBtn = document.querySelector('.close-search-modal-btn');
        const desktopSearchForm = document.getElementById('desktop-search-form');
        const desktopSearchInput = document.getElementById('desktop-search-input');

        if (desktopSearchBtn && searchModal) {
            desktopSearchBtn.addEventListener('click', (e) => { e.preventDefault(); searchModal.style.display = 'block'; desktopSearchInput.focus(); });
            const closeSearchModal = () => { searchModal.style.display = 'none'; };
            closeSearchModalBtn.addEventListener('click', closeSearchModal);
            searchModal.addEventListener('click', (e) => { if (e.target === searchModal) closeSearchModal(); });
            desktopSearchForm.addEventListener('submit', (e) => { e.preventDefault(); const query = desktopSearchInput.value.trim(); if (query) window.location.href = `/catalog.html?search=${encodeURIComponent(query)}`; });
        }
        
        const mobileSearchForm = document.querySelector('.mobile-search .search-box');
        if (mobileSearchForm) {
            const mobileSearchInput = mobileSearchForm.querySelector('input');
            mobileSearchForm.addEventListener('submit', (e) => { e.preventDefault(); const query = mobileSearchInput.value.trim(); if (query) window.location.href = `/catalog.html?search=${encodeURIComponent(query)}`; });
        }
        // --- END: HEADER COUNTERS & AUTH LOGIC ---

        async function fetchAllData() {
            const [heroSnap, categoriesSnap, productsSnap, reviewsSnap] = await Promise.all([
                getDoc(doc(db, "siteContent", "hero")),
                getDocs(query(collection(db, "categories"))),
                getDocs(query(collection(db, "products"))),
                getDocs(query(collectionGroup(db, 'reviews')))
            ]);
            
            localData.hero = heroSnap.exists() ? heroSnap.data() : {};
            localData.categories = categoriesSnap.docs.map(d => ({ id: d.id, ...d.data() }));
            localData.products = productsSnap.docs.map(d => ({ id: d.id, ...d.data() }));
            
            const reviewsWithProductData = await Promise.all(reviewsSnap.docs.map(async (reviewDoc) => {
                const reviewData = { id: reviewDoc.id, ...reviewDoc.data() };
                const productRef = reviewDoc.ref.parent.parent;
                if (productRef) {
                    reviewData.product = { id: productRef.id };
                    const productInfo = localData.products.find(p => p.id === productRef.id);
                    if (productInfo) {
                        reviewData.product.slug = productInfo.slug;
                        reviewData.product.category = productInfo.category;
                    }
                }
                return reviewData;
            }));
            localData.reviews = reviewsWithProductData;
        }

        function initializeAdminPanel() {
            const adminMenuLinks = document.querySelectorAll('.admin-menu a');
            const adminViews = document.querySelectorAll('.admin-view');

            adminMenuLinks.forEach(link => {
                link.addEventListener('click', e => {
                    e.preventDefault();
                    const viewId = `admin-view-${link.dataset.view}`;
                    adminMenuLinks.forEach(l => l.classList.remove('active'));
                    link.classList.add('active');
                    adminViews.forEach(view => view.classList.remove('active'));
                    document.getElementById(viewId).classList.add('active');
                });
            });

            function generateSlug(text) { return text.toString().toLowerCase().replace(/\s+/g, '-').replace(/[^\w\-]+/g, '').replace(/\-\-+/g, '-').replace(/^-+/, '').replace(/-+$/, ''); }

            const heroForm = document.getElementById('hero-form');
            function loadHeroAdmin() { Object.keys(localData.hero).forEach(key => { if(heroForm[key]) heroForm[key].value = localData.hero[key]; }); }
            heroForm.addEventListener('submit', async (e) => { e.preventDefault(); const formData = new FormData(heroForm); const updatedData = Object.fromEntries(formData.entries()); try { await updateDoc(doc(db, "siteContent", "hero"), updatedData); localData.hero = updatedData; showToast('Hero section updated!', 'success'); } catch (error) { showToast('Error updating hero.', 'danger'); } });

            const categoryFormContainer = document.getElementById('category-form-container');
            const categoryForm = document.getElementById('category-form');
            const categoriesTableBody = document.getElementById('categories-table-body');
            document.getElementById('category-name').addEventListener('input', (e) => { document.getElementById('category-slug').value = generateSlug(e.target.value); });
            document.getElementById('btn-add-category').addEventListener('click', () => { categoryForm.reset(); categoryForm['id'].value = ''; categoryFormContainer.style.display = 'block'; });
            document.getElementById('category-cancel-btn').addEventListener('click', () => { categoryFormContainer.style.display = 'none'; });
            
            function loadCategoriesAdmin() {
                categoriesTableBody.innerHTML = '';
                localData.categories.forEach(cat => {
                    const row = categoriesTableBody.insertRow();
                    if (cat.isArchived) row.classList.add('archived-item');
                    const categoryLink = `<a href="/catalog.html?category=${encodeURIComponent(cat.name)}" class="product-link" target="_blank">${cat.name}</a>`;
                    row.innerHTML = `<td><img src="${cat.imageUrl}" alt="${cat.name}"></td><td>${categoryLink}</td><td>${cat.slug || 'N/A'}</td><td>${cat.isArchived ? 'Archived' : 'Active'}</td><td class="actions-cell"><button class="btn-edit" data-id="${cat.id}"><i class="fas fa-edit"></i></button><button class="${cat.isArchived ? 'btn-restore' : 'btn-archive'}" data-id="${cat.id}"><i class="fas ${cat.isArchived ? 'fa-undo' : 'fa-archive'}"></i></button><button class="btn-delete" data-id="${cat.id}"><i class="fas fa-trash"></i></button></td>`;
                });
            }
            
            categoryForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = categoryForm['id'].value;
                const formData = { name: categoryForm['name'].value, slug: categoryForm['slug'].value, imageUrl: categoryForm['imageUrl'].value, productCount: parseInt(categoryForm['productCount'].value), metaTitle: categoryForm['metaTitle'].value, metaDescription: categoryForm['metaDescription'].value };
                try {
                    if (id) {
                        await updateDoc(doc(db, "categories", id), formData);
                        const index = localData.categories.findIndex(c => c.id === id);
                        localData.categories[index] = { ...localData.categories[index], ...formData };
                    } else {
                        const docRef = await addDoc(collection(db, "categories"), { ...formData, isArchived: false });
                        localData.categories.push({ id: docRef.id, ...formData, isArchived: false });
                    }
                    categoryFormContainer.style.display = 'none';
                    loadCategoriesAdmin();
                    showToast('Category saved!', 'success');
                } catch (error) { showToast('Error saving category.', 'danger'); }
            });
            
            categoriesTableBody.addEventListener('click', async (e) => { 
                const target = e.target.closest('button'); if (!target) return; const id = target.dataset.id; const category = localData.categories.find(c => c.id === id); 
                if (target.classList.contains('btn-edit')) { Object.keys(category).forEach(key => { if(categoryForm[key]) categoryForm[key].value = category[key] || ''; }); categoryForm['id'].value = category.id; categoryFormContainer.style.display = 'block'; } 
                else if (target.classList.contains('btn-archive') || target.classList.contains('btn-restore')) { const newStatus = !category.isArchived; await updateDoc(doc(db, "categories", id), { isArchived: newStatus }); category.isArchived = newStatus; loadCategoriesAdmin(); showToast(`Category ${newStatus ? 'archived' : 'restored'}!`, 'info'); } 
                else if (target.classList.contains('btn-delete')) { if (confirm('Delete category?')) { await deleteDoc(doc(db, "categories", id)); localData.categories = localData.categories.filter(c => c.id !== id); loadCategoriesAdmin(); showToast('Category deleted!', 'success'); } } 
            });

            const productFormContainer = document.getElementById('product-form-container');
            const productForm = document.getElementById('product-form');
            const productsTableBody = document.getElementById('products-table-body');
            const productCategorySelect = document.getElementById('product-category');
            document.getElementById('product-name').addEventListener('input', (e) => { document.getElementById('product-slug').value = generateSlug(e.target.value); });
            
            function populateCategorySelect() { productCategorySelect.innerHTML = localData.categories.filter(c => !c.isArchived).map(c => `<option value="${c.name}">${c.name}</option>`).join(''); }
            document.getElementById('btn-add-product').addEventListener('click', () => { productForm.reset(); productForm['product-id'].value = ''; populateCategorySelect(); productFormContainer.style.display = 'block'; });
            document.getElementById('product-cancel-btn').addEventListener('click', () => { productFormContainer.style.display = 'none'; });
            
            function loadProductsAdmin() {
                productsTableBody.innerHTML = '';
                localData.products.forEach(prod => {
                    const row = productsTableBody.insertRow();
                    if (prod.isArchived) row.classList.add('archived-item');
                    const displayImage = (prod.imageUrls && prod.imageUrls.length > 0) ? prod.imageUrls[0] : prod.imageUrl;
                    const categorySlug = prod.category ? prod.category.toLowerCase().replace(/\s+/g, '-') : 'general';
                    const productUrl = `/${categorySlug}/${prod.slug}`;
                    const productLink = `<a href="${productUrl}" class="product-link" target="_blank">${prod.name}</a>`;
                    row.innerHTML = `<td><img src="${displayImage}" alt="${prod.name}"></td><td>${productLink}</td><td>$${prod.price.toFixed(2)}</td><td>${prod.isArchived ? 'Archived' : 'Active'}</td><td class="actions-cell"><button class="btn-edit" data-id="${prod.id}"><i class="fas fa-edit"></i></button><button class="${prod.isArchived ? 'btn-restore' : 'btn-archive'}" data-id="${prod.id}"><i class="fas ${prod.isArchived ? 'fa-undo' : 'fa-archive'}"></i></button><button class="btn-delete" data-id="${prod.id}"><i class="fas fa-trash"></i></button></td>`;
                });
            }
            
            productForm.addEventListener('submit', async (e) => { 
                e.preventDefault(); const id = productForm['product-id'].value; const imageUrls = productForm.imageUrls.value.split('\n').map(url => url.trim()).filter(url => url); 
                const formData = { name: productForm.name.value, slug: productForm.slug.value, region: productForm.region.value, country: productForm.country.value, appellation: productForm.appellation.value, year: parseInt(productForm.year.value) || null, grapeVarieties: productForm.grapeVarieties.value, sweetness: productForm.sweetness.value, alcohol: parseFloat(productForm.alcohol.value) || null, volume: productForm.volume.value, category: productForm.category.value, imageUrl: imageUrls.length > 0 ? imageUrls[0] : '', imageUrls: imageUrls, description: productForm.description.value, price: parseFloat(productForm.price.value), oldPrice: parseFloat(productForm.oldPrice.value) || null, badge: productForm.badge.value, stockStatus: productForm.stockStatus.value, tastingNotes: productForm.tastingNotes.value, foodPairing: productForm.foodPairing.value, serving: productForm.serving.value, metaTitle: productForm.metaTitle.value, metaDescription: productForm.metaDescription.value, sku: productForm.sku.value, brand: productForm.brand.value, gtin: productForm.gtin.value, ratingValue: parseFloat(productForm.ratingValue.value) || null, reviewCount: parseInt(productForm.reviewCount.value) || null, }; 
                try { 
                    if (id) { await updateDoc(doc(db, "products", id), formData); const index = localData.products.findIndex(p => p.id === id); localData.products[index] = { ...localData.products[index], ...formData }; } 
                    else { const docRef = await addDoc(collection(db, "products"), { ...formData, isArchived: false }); localData.products.push({ id: docRef.id, ...formData, isArchived: false }); } 
                    productFormContainer.style.display = 'none'; loadProductsAdmin(); showToast('Product saved!', 'success'); 
                } catch (error) { showToast('Error saving product.', 'danger'); } 
            });
            
            productsTableBody.addEventListener('click', async (e) => { 
                const target = e.target.closest('button'); if (!target) return; const id = target.dataset.id; const product = localData.products.find(p => p.id === id); 
                if (target.classList.contains('btn-edit')) { 
                    populateCategorySelect(); 
                    Object.keys(product).forEach(key => { if (productForm[key]) { if (key === 'imageUrls') { productForm[key].value = (product[key] && product[key].length > 0) ? product[key].join('\n') : ''; } else { productForm[key].value = product[key] || ''; } } }); 
                    productForm['product-id'].value = product.id; productFormContainer.style.display = 'block'; window.scrollTo({ top: productFormContainer.offsetTop - 20, behavior: 'smooth' }); 
                } else if (target.classList.contains('btn-archive') || target.classList.contains('btn-restore')) { 
                    const newStatus = !product.isArchived; await updateDoc(doc(db, "products", id), { isArchived: newStatus }); product.isArchived = newStatus; loadProductsAdmin(); showToast(`Product ${newStatus ? 'archived' : 'restored'}!`, 'info'); 
                } else if (target.classList.contains('btn-delete')) { if (confirm('Delete product?')) { await deleteDoc(doc(db, "products", id)); localData.products = localData.products.filter(p => p.id !== id); loadProductsAdmin(); showToast('Product deleted!', 'success'); } } 
            });

            const reviewsTableBody = document.getElementById('reviews-table-body');
            const reviewModal = document.getElementById('review-modal');
            const reviewForm = document.getElementById('review-form');
            
            function loadReviewsAdmin() {
                reviewsTableBody.innerHTML = '';
                localData.reviews.forEach(review => {
                    const product = localData.products.find(p => p.id === review.product?.id);
                    const row = reviewsTableBody.insertRow();
                    const reviewDate = review.createdAt?.toDate ? review.createdAt.toDate().toLocaleDateString() : 'N/A';
                    const stars = '★'.repeat(review.rating || 0) + '☆'.repeat(5 - (review.rating || 0));
                    let productUrl = '#';
                    if (product && product.slug && product.category) { const categorySlug = product.category.toLowerCase().replace(/\s+/g, '-'); productUrl = `/${categorySlug}/${product.slug}`; }
                    row.innerHTML = `<td><a href="${productUrl}" class="product-link" target="_blank">${product?.name || 'Unknown Product'}</a></td><td>${review.userName || 'Anonymous'}</td><td class="review-rating">${stars}</td><td>${review.title || ''}</td><td class="comment-cell">${review.text || review.comment || ''}</td><td>${reviewDate}</td><td class="actions-cell"><button class="btn-edit" data-id="${review.id}"><i class="fas fa-edit"></i></button><button class="btn-delete" data-id="${review.id}"><i class="fas fa-trash"></i></button></td>`;
                });
            }

            reviewsTableBody.addEventListener('click', async (e) => {
                const target = e.target.closest('button'); if (!target) return; const id = target.dataset.id; const review = localData.reviews.find(r => r.id === id); if (!review) return;
                if (target.classList.contains('btn-edit')) { reviewForm.reset(); reviewForm['review-id'].value = review.id; reviewForm['review-product-id'].value = review.product.id; reviewForm['review-title-input'].value = review.title || ''; reviewForm['review-comment-input'].value = review.text || review.comment || ''; const ratingInput = reviewForm.querySelector(`input[name="rating"][value="${review.rating}"]`); if(ratingInput) ratingInput.checked = true; reviewModal.classList.add('active'); } 
                else if (target.classList.contains('btn-delete')) { if (confirm('Are you sure you want to delete this review? This action cannot be undone.')) { await deleteReview(review.product.id, review.id); showToast('Review deleted!', 'success'); } }
            });

            reviewModal.querySelector('.close-modal').addEventListener('click', () => reviewModal.classList.remove('active'));
            reviewModal.querySelector('.btn-cancel').addEventListener('click', () => reviewModal.classList.remove('active'));
            reviewForm.addEventListener('submit', async (e) => { e.preventDefault(); await handleReviewUpdate(); reviewModal.classList.remove('active'); showToast('Review updated!', 'success'); });

            async function handleReviewUpdate() {
                const reviewId = reviewForm['review-id'].value; const productId = reviewForm['review-product-id'].value; const newRating = Number(reviewForm.querySelector('input[name="rating"]:checked').value); const newTitle = reviewForm['review-title-input'].value; const newText = reviewForm['review-comment-input'].value;
                const productRef = doc(db, "products", productId); const reviewRef = doc(db, `products/${productId}/reviews`, reviewId);
                try {
                    await runTransaction(db, async (transaction) => {
                        const [productDoc, reviewDoc] = await Promise.all([transaction.get(productRef), transaction.get(reviewRef)]); if (!productDoc.exists() || !reviewDoc.exists()) throw "Product or Review not found!";
                        const productData = productDoc.data(); const oldRating = reviewDoc.data().rating; const reviewCount = productData.reviewCount || 1; const newAverageRating = ((productData.ratingValue || 0) * reviewCount - oldRating + newRating) / reviewCount;
                        transaction.update(productRef, { ratingValue: parseFloat(newAverageRating.toFixed(2)) }); transaction.update(reviewRef, { rating: newRating, title: newTitle, text: newText, comment: newText });
                    });
                    const reviewIndex = localData.reviews.findIndex(r => r.id === reviewId); localData.reviews[reviewIndex] = { ...localData.reviews[reviewIndex], rating: newRating, title: newTitle, text: newText, comment: newText };
                    const productIndex = localData.products.findIndex(p => p.id === productId);
                    if (productIndex > -1) { const product = localData.products[productIndex]; const oldRating = localData.reviews[reviewIndex].rating; const reviewCount = product.reviewCount || 1; product.ratingValue = ((product.ratingValue || 0) * reviewCount - oldRating + newRating) / reviewCount; }
                    loadReviewsAdmin();
                } catch (error) { console.error("Error updating review:", error); showToast("Failed to update review.", 'danger'); }
            }

            async function deleteReview(productId, reviewId) {
                const productRef = doc(db, "products", productId); const reviewRef = doc(db, `products/${productId}/reviews`, reviewId);
                try {
                    await runTransaction(db, async (transaction) => {
                        const [productDoc, reviewDoc] = await Promise.all([transaction.get(productRef), transaction.get(reviewRef)]); if (!productDoc.exists() || !reviewDoc.exists()) throw "Product or Review not found!";
                        const productData = productDoc.data(); const deletedRating = reviewDoc.data().rating; const oldReviewCount = productData.reviewCount || 1; const newReviewCount = oldReviewCount - 1; let newAverageRating = 0;
                        if (newReviewCount > 0) { newAverageRating = ((productData.ratingValue || 0) * oldReviewCount - deletedRating) / newReviewCount; }
                        transaction.update(productRef, { reviewCount: newReviewCount, ratingValue: parseFloat(newAverageRating.toFixed(2)) }); transaction.delete(reviewRef);
                    });
                    localData.reviews = localData.reviews.filter(r => r.id !== reviewId);
                    const productIndex = localData.products.findIndex(p => p.id === productId); if (productIndex > -1) { localData.products[productIndex].reviewCount--; }
                    loadReviewsAdmin();
                } catch (error) { console.error("Error deleting review:", error); showToast("Failed to delete review.", 'danger'); }
            }

            const usersTableBody = document.getElementById('users-table-body');
            const orderModal = document.getElementById('order-modal');
            const userSummaryModal = document.getElementById('user-summary-modal');
            const orderDetailsContent = document.getElementById('order-details-content');
            usersTableBody.addEventListener('change', (e) => { if (e.target.classList.contains('order-status-select')) { const orderId = e.target.dataset.orderId; const newStatus = e.target.value; showToast(`Order ${orderId} status updated to ${newStatus}`, 'success'); } });
            usersTableBody.addEventListener('click', (e) => {
                const target = e.target.closest('button'); if (!target) return;
                if (target.classList.contains('view-order-details')) { showOrderDetails(target.dataset.orderId); } 
                else if (target.classList.contains('view-user-summary')) { showUserSummary(target.dataset.userId); }
            });
            function showOrderDetails(orderId) { orderDetailsContent.innerHTML = `<div class="form-section"><h4>Order Information</h4><div class="form-group"><label>Order ID:</label><p>${orderId}</p></div><div class="form-group"><label>Order Date:</label><p>${new Date().toLocaleDateString()}</p></div><div class="form-group"><label>Customer:</label><p>Demo Customer</p></div><div class="form-group"><label>Total Amount:</label><p>$125.00</p></div></div><div class="form-section"><h4>Order Items</h4><div class="reviews-table-wrapper"><table class="prepared-table"><thead><tr><th>Product</th><th>Quantity</th><th>Price</th><th>Total</th></tr></thead><tbody><tr><td>Château Margaux 2018</td><td>1</td><td>$125.00</td><td>$125.00</td></tr></tbody></table></div></div>`; orderModal.classList.add('active'); }
            function showUserSummary(userId) {
                document.getElementById('user-orders-table').innerHTML = `<tr><td>#ORD-001</td><td>${new Date().toLocaleDateString()}</td><td>$125.00</td><td><span class="status-badge status-collected">Collected</span></td></tr><tr><td>#ORD-002</td><td>${new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toLocaleDateString()}</td><td>$89.00</td><td><span class="status-badge status-delivered">Delivered</span></td></tr>`;
                document.getElementById('user-wishlist-table').innerHTML = `<tr><td>Dom Pérignon 2010</td><td>$199.00</td><td>${new Date().toLocaleDateString()}</td></tr><tr><td>Opus One 2019</td><td>$299.00</td><td>${new Date(Date.now() - 3 * 24 * 60 * 60 * 1000).toLocaleDateString()}</td></tr>`;
                document.getElementById('user-reviews-table').innerHTML = `<tr><td>Château Margaux 2018</td><td>★★★★★</td><td>Excellent wine, highly recommended!</td><td>${new Date().toLocaleDateString()}</td></tr>`;
                document.getElementById('user-cart-table').innerHTML = `<tr><td>Screaming Eagle 2016</td><td>1</td><td>$899.00</td></tr><tr><td>Silver Oak 2018</td><td>2</td><td>$129.00</td></tr>`;
                userSummaryModal.classList.add('active');
            }
            const userSummaryTabs = document.querySelectorAll('.user-summary-tab');
            const userSummaryTabContents = document.querySelectorAll('.user-summary-tab-content');
            userSummaryTabs.forEach(tab => { tab.addEventListener('click', () => { const tabId = tab.dataset.tab; userSummaryTabs.forEach(t => t.classList.remove('active')); userSummaryTabContents.forEach(c => c.classList.remove('active')); tab.classList.add('active'); document.getElementById(`${tabId}-tab`).classList.add('active'); }); });
            document.querySelectorAll('.close-modal').forEach(btn => { btn.addEventListener('click', () => { document.querySelectorAll('.review-modal, .order-modal, .user-summary-modal').forEach(modal => { modal.classList.remove('active'); }); }); });
            document.querySelectorAll('.btn-cancel').forEach(btn => { btn.addEventListener('click', () => { document.querySelectorAll('.review-modal, .order-modal, .user-summary-modal').forEach(modal => { modal.classList.remove('active'); }); }); });

            loadHeroAdmin();
            loadCategoriesAdmin();
            loadProductsAdmin();
            loadReviewsAdmin();
        }

        // --- START: KYC MANAGER (DYNAMIC VERSION) ---
        class KYCManager {
            constructor() { this.init(); }
            init() { this.bindEvents(); this.loadKYCData(); }
            bindEvents() {
                document.addEventListener('click', (e) => {
                    const button = e.target.closest('button');
                    if (!button) return;
                    const userId = button.dataset.userId;
                    const orderId = button.dataset.orderId;
                    if (button.classList.contains('view-kyc-orders')) this.openModal('kyc-orders-modal', userId);
                    else if (button.classList.contains('view-kyc-reviews')) this.openModal('kyc-reviews-modal', userId);
                    else if (button.classList.contains('view-kyc-cart')) this.openModal('kyc-cart-modal', userId);
                    else if (button.classList.contains('view-kyc-wishlist')) this.openModal('kyc-wishlist-modal', userId);
                    else if (button.classList.contains('view-kyc-address')) this.openModal('kyc-address-modal', userId);
                    else if (button.classList.contains('view-order-full-details')) this.openModal('order-full-details-modal', null, orderId);
                });
                document.querySelectorAll('.close-kyc-modal, .kyc-modal .btn-cancel').forEach(btn => btn.addEventListener('click', () => this.closeAllModals()));
                document.querySelectorAll('.kyc-modal').forEach(modal => modal.addEventListener('click', (e) => { if (e.target === modal) this.closeAllModals(); }));
            }
            async loadKYCData() {
                try {
                    const users = await this.fetchKYCDataFromFirestore();
                    this.renderKYCTable(users);
                } catch (error) { console.error('Error loading KYC data:', error); showToast('Failed to load KYC data', 'danger'); }
            }
            async fetchKYCDataFromFirestore() {
                const usersSnapshot = await getDocs(collection(db, "users"));
                return usersSnapshot.docs.map(doc => ({
                    id: doc.id,
                    name: doc.data().displayName || 'N/A',
                    email: doc.data().email,
                    totalOrders: doc.data().totalOrders || 0,
                    totalSpent: doc.data().totalSpent || 0,
                    lastActivity: doc.data().lastActivity?.toDate().toLocaleDateString() || 'N/A'
                }));
            }
            renderKYCTable(users) {
                const tbody = document.getElementById('kyc-table-body');
                if (!tbody) return;
                tbody.innerHTML = users.map(user => `
                    <tr>
                        <td>${user.name}</td><td>${user.email}</td><td>${user.totalOrders} orders</td><td>$${user.totalSpent.toFixed(2)}</td><td>${user.lastActivity}</td>
                        <td class="actions-cell">
                            <button class="btn-edit view-kyc-orders" data-user-id="${user.id}"><i class="fas fa-shopping-bag"></i> Orders</button>
                            <button class="btn-archive view-kyc-reviews" data-user-id="${user.id}"><i class="fas fa-star"></i> Reviews</button>
                            <button class="btn-restore view-kyc-cart" data-user-id="${user.id}"><i class="fas fa-shopping-cart"></i> Cart</button>
                            <button class="btn-delete view-kyc-wishlist" data-user-id="${user.id}"><i class="fas fa-heart"></i> Wishlist</button>
                            <button class="btn-edit view-kyc-address" data-user-id="${user.id}"><i class="fas fa-map-marker-alt"></i> Address</button>
                        </td>
                    </tr>`).join('');
            }
            async openModal(modalId, userId, orderId) {
                const modal = document.getElementById(modalId);
                if (!modal) return;
                const titleEl = modal.querySelector('h3');
                if (userId) {
                    const userDoc = await getDoc(doc(db, "users", userId));
                    const userName = userDoc.exists() ? userDoc.data().displayName : 'Unknown User';
                    if (titleEl) titleEl.textContent = `${titleEl.textContent.split(' - ')[0]} - ${userName}`;
                }
                if (orderId && titleEl) titleEl.textContent = `Order Details - #${orderId}`;
                const contentArea = modal.querySelector('tbody') || modal.querySelector('.form-section');
                if(contentArea) contentArea.innerHTML = '<tr><td colspan="100%">Loading...</td></tr>';
                modal.classList.add('active');
                if (modalId === 'kyc-orders-modal') this.populateOrdersData(modal, userId);
                else if (modalId === 'kyc-reviews-modal') this.populateReviewsData(modal, userId);
                else if (modalId === 'kyc-cart-modal') this.populateCartData(modal, userId);
                else if (modalId === 'kyc-wishlist-modal') this.populateWishlistData(modal, userId);
                else if (modalId === 'kyc-address-modal') this.populateAddressData(modal, userId);
                else if (modalId === 'order-full-details-modal') this.populateOrderDetails(modal, orderId);
            }
            closeAllModals() { document.querySelectorAll('.kyc-modal').forEach(modal => modal.classList.remove('active')); }
            async populateOrdersData(modal, userId) {
                const tbody = modal.querySelector('tbody');
                try {
                    const q = query(collection(db, "orders"), where("userId", "==", userId));
                    const snapshot = await getDocs(q);
                    if (snapshot.empty) { tbody.innerHTML = '<tr><td colspan="6">No orders found for this user.</td></tr>'; return; }
                    tbody.innerHTML = snapshot.docs.map(doc => {
                        const order = doc.data();
                        return `<tr><td>#${doc.id}</td><td>${order.orderDate.toDate().toLocaleDateString()}</td><td>${order.items.length} items</td><td>$${order.totalAmount.toFixed(2)}</td><td><span class="status-badge status-${order.status}">${order.status}</span></td><td class="actions-cell"><button class="btn-edit view-order-full-details" data-order-id="${doc.id}"><i class="fas fa-eye"></i> View</button></td></tr>`;
                    }).join('');
                } catch (e) { tbody.innerHTML = '<tr><td colspan="6">Error loading orders.</td></tr>'; console.error(e); }
            }
            async populateReviewsData(modal, userId) {
                const tbody = modal.querySelector('tbody');
                try {
                    const q = query(collectionGroup(db, 'reviews'), where("userId", "==", userId));
                    const snapshot = await getDocs(q);
                    if (snapshot.empty) { tbody.innerHTML = '<tr><td colspan="5">No reviews found from this user.</td></tr>'; return; }
                    const reviewsHtml = await Promise.all(snapshot.docs.map(async (doc) => {
                        const review = doc.data();
                        const productRef = doc.ref.parent.parent;
                        const productSnap = await getDoc(productRef);
                        const productName = productSnap.exists() ? productSnap.data().name : 'Unknown Product';
                        return `<tr><td>${productName}</td><td class="review-rating">${'★'.repeat(review.rating)}${'☆'.repeat(5 - review.rating)}</td><td>${review.title}</td><td class="comment-cell">${review.text}</td><td>${review.createdAt.toDate().toLocaleDateString()}</td></tr>`;
                    }));
                    tbody.innerHTML = reviewsHtml.join('');
                } catch (e) { tbody.innerHTML = '<tr><td colspan="5">Error loading reviews.</td></tr>'; console.error(e); }
            }
            async populateCartData(modal, userId) {
                const tbody = modal.querySelector('tbody');
                const summarySection = modal.querySelector('.form-section');
                try {
                    const cartSnapshot = await getDocs(collection(db, `users/${userId}/cart`));
                    if (cartSnapshot.empty) { tbody.innerHTML = '<tr><td colspan="4">The cart is empty.</td></tr>'; summarySection.innerHTML = ''; return; }
                    let subtotal = 0;
                    const cartItemsHtml = await Promise.all(cartSnapshot.docs.map(async (itemDoc) => {
                        const item = itemDoc.data();
                        const productSnap = await getDoc(doc(db, "products", itemDoc.id));
                        if (!productSnap.exists()) return '';
                        const product = productSnap.data();
                        const itemTotal = product.price * item.quantity;
                        subtotal += itemTotal;
                        return `<tr><td>${product.name}</td><td>${item.quantity}</td><td>$${product.price.toFixed(2)}</td><td>$${itemTotal.toFixed(2)}</td></tr>`;
                    }));
                    tbody.innerHTML = cartItemsHtml.join('');
                    summarySection.innerHTML = `<div class="form-row"><div class="form-group" style="flex: 1;"><label><strong>Total:</strong></label><p><strong>$${subtotal.toFixed(2)}</strong></p></div></div>`;
                } catch (e) { tbody.innerHTML = '<tr><td colspan="4">Error loading cart.</td></tr>'; console.error(e); }
            }
            async populateWishlistData(modal, userId) {
                const tbody = modal.querySelector('tbody');
                try {
                    const userSnap = await getDoc(doc(db, "users", userId));
                    if (!userSnap.exists() || !userSnap.data().wishlist || userSnap.data().wishlist.length === 0) { tbody.innerHTML = '<tr><td colspan="4">The wishlist is empty.</td></tr>'; return; }
                    const wishlistIds = userSnap.data().wishlist;
                    const wishlistItemsHtml = await Promise.all(wishlistIds.map(async (productId) => {
                        const productSnap = await getDoc(doc(db, "products", productId));
                        if (!productSnap.exists()) return '';
                        const product = productSnap.data();
                        return `<tr><td>${product.name}</td><td>$${product.price.toFixed(2)}</td><td>${product.category}</td><td>N/A</td></tr>`;
                    }));
                    tbody.innerHTML = wishlistItemsHtml.join('');
                } catch (e) { tbody.innerHTML = '<tr><td colspan="4">Error loading wishlist.</td></tr>'; console.error(e); }
            }
            async populateAddressData(modal, userId) {
                const primarySection = modal.querySelector('.primary-address-container');
                const altTbody = modal.querySelector('tbody');

                if (!primarySection) {
                    console.error("Could not find the primary address container in the modal.");
                    return; 
                }

                try {
                    const addressesCol = collection(db, `users/${userId}/addresses`);
                    const snapshot = await getDocs(addressesCol);

                    if (snapshot.empty) {
                        primarySection.innerHTML = '<p>No address found for this user.</p>';
                        if (altTbody) altTbody.innerHTML = '<tr><td colspan="4">No alternative addresses.</td></tr>';
                        return;
                    }
                    
                    let primaryAddressDoc = snapshot.docs.find(doc => doc.data().isDefault);
                    if (!primaryAddressDoc) {
                        primaryAddressDoc = snapshot.docs[0];
                    }
                    const primaryAddress = primaryAddressDoc.data();
                    const fullName = `${primaryAddress.firstName || ''} ${primaryAddress.lastName || ''}`.trim();

                    primarySection.innerHTML = `
                        <div class="form-group">
                            <label><strong>Primary Delivery Address:</strong></label>
                            <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; margin-top: 10px;">
                                <p><strong>${fullName}</strong></p>
                                <p>${primaryAddress.line1 || ''}</p>
                                ${primaryAddress.line2 ? `<p>${primaryAddress.line2}</p>` : ''}
                                <p>${primaryAddress.city || ''}, ${primaryAddress.state || ''} ${primaryAddress.zip || ''}</p>
                                <p>${primaryAddress.country || ''}</p>
                                <p>📞 ${primaryAddress.phone || 'N/A'}</p>
                            </div>
                        </div>`;
                    
                    if (altTbody) {
                        altTbody.innerHTML = '<tr><td colspan="4">Functionality for alternative addresses not implemented yet.</td></tr>';
                    }

                } catch (e) {
                    primarySection.innerHTML = '<p>Error loading address information.</p>';
                    if (altTbody) altTbody.innerHTML = '';
                    console.error("Error fetching address:", e);
                }
            }
            async populateOrderDetails(modal, orderId) {
                try {
                    const orderSnap = await getDoc(doc(db, "orders", orderId));
                    if (!orderSnap.exists()) { modal.querySelector('.form-section:first-child .form-row').innerHTML = '<p>Order not found.</p>'; return; }
                    const order = orderSnap.data();
                    const userSnap = await getDoc(doc(db, "users", order.userId));
                    const user = userSnap.exists() ? userSnap.data() : {};
                    modal.querySelector('.form-section:nth-child(1) .form-row').innerHTML = `<div class="form-group" style="flex: 1;"><label>Order ID:</label><p>#${orderId}</p></div><div class="form-group" style="flex: 1;"><label>Order Date:</label><p>${order.orderDate.toDate().toLocaleString()}</p></div><div class="form-group" style="flex: 1;"><label>Status:</label><p><span class="status-badge status-${order.status}">${order.status}</span></p></div>`;
                    modal.querySelector('.form-section:nth-child(2) .form-row').innerHTML = `<div class="form-group" style="flex: 1;"><label>Customer Name:</label><p>${user.displayName || 'N/A'}</p></div><div class="form-group" style="flex: 1;"><label>Email:</label><p>${user.email || 'N/A'}</p></div>`;
                    const itemsHtml = await Promise.all(order.items.map(async item => {
                        const productSnap = await getDoc(doc(db, "products", item.productId));
                        const product = productSnap.exists() ? productSnap.data() : { name: 'Product not found', sku: 'N/A' };
                        return `<tr><td>${product.name}</td><td>${product.sku}</td><td>${item.quantity}</td><td>$${item.price.toFixed(2)}</td><td>$${(item.price * item.quantity).toFixed(2)}</td></tr>`;
                    }));
                    modal.querySelector('.form-section:nth-child(3) tbody').innerHTML = itemsHtml.join('');
                    modal.querySelector('.form-section:nth-child(4) .form-row').innerHTML = `<div class="form-group" style="flex: 1;"><label><strong>Total:</strong></label><p><strong>$${order.totalAmount.toFixed(2)}</strong></p></div>`;
                    modal.querySelector('.form-section:nth-child(5)').innerHTML = `<h4>Shipping Information</h4><p>${order.shippingAddress.street}, ${order.shippingAddress.city}...</p>`;
                } catch (e) { modal.querySelector('.form-section:first-child .form-row').innerHTML = '<p>Error loading order details.</p>'; console.error(e); }
            }
        }
        // --- END: KYC MANAGER ---

        async function main() {
            try {
                await fetchAllData();
                initializeAdminPanel();
                new KYCManager(); // Initialize KYC section
            } catch (error) {
                console.error("Error initializing admin panel: ", error);
                document.querySelector('.admin-main-content').innerHTML = `<div style="padding: 40px; text-align: center;"><h2>Error loading admin data.</h2><p>${error.message}</p></div>`;
            }
        }
        main();
    });
    </script>
</body>
</html>