<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - VinoElite</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- GLOBAL STYLES --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        :root { --primary-color: #c19a6b; --primary-dark: #a67c52; --primary-light: #e8c8a0; --bg-dark: #1a1a1a; --bg-darker: #0f0f0f; --bg-light: #2d1b1b; --text-light: #f5f5f5; --text-muted: #b0b0b0; --border-color: rgba(255, 255, 255, 0.1); --success-color: #28a745; --danger-color: #dc3545; }
        body { background: linear-gradient(135deg, var(--bg-dark) 0%, var(--bg-light) 100%); color: var(--text-light); line-height: 1.6; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        button, .btn { cursor: pointer; transition: all 0.3s ease; }

        /* --- ADMIN PANEL STYLES --- */
        #admin-panel { padding: 40px 0; }
        .admin-container { display: flex; gap: 30px; align-items: flex-start; }
        .admin-sidebar { width: 250px; flex-shrink: 0; background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 15px; border: 1px solid var(--border-color); }
        .admin-sidebar h2 { font-size: 1.5rem; color: var(--primary-light); margin-bottom: 20px; text-align: center; }
        .admin-menu { list-style: none; }
        .admin-menu li a { display: block; padding: 12px 15px; color: var(--text-light); text-decoration: none; border-radius: 8px; margin-bottom: 5px; transition: background 0.3s ease; }
        .admin-menu li a:hover, .admin-menu li a.active { background: var(--primary-color); color: var(--bg-dark); }
        .admin-main-content { flex-grow: 1; }
        .admin-view { display: none; background: rgba(255, 255, 255, 0.05); padding: 30px; border-radius: 15px; border: 1px solid var(--border-color); }
        .admin-view.active { display: block; }
        .admin-view h3 { font-size: 2rem; font-weight: 300; color: var(--primary-light); margin-bottom: 25px; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; }
        .admin-view h4 { font-size: 1.5rem; font-weight: 400; color: var(--primary-light); margin-top: 30px; margin-bottom: 20px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: var(--text-muted); }
        .form-group input, .form-group textarea, .form-group select { width: 100%; background: rgba(0, 0, 0, 0.2); border: 1px solid var(--border-color); color: var(--text-light); padding: 12px; border-radius: 8px; font-size: 1rem; }
        .form-group textarea { min-height: 120px; resize: vertical; }
        .form-group small { display: block; margin-top: 5px; color: var(--text-muted); font-size: 0.8rem; }
        .btn-save { background: var(--success-color); color: white; border: none; padding: 12px 25px; border-radius: 8px; font-size: 1rem; font-weight: 600; }
        .btn-add-new { background: var(--primary-color); color: var(--bg-dark); border: none; padding: 10px 20px; border-radius: 8px; font-size: 0.9rem; font-weight: 600; margin-bottom: 20px; }
        .admin-table { width: 100%; border-collapse: collapse; }
        .admin-table th, .admin-table td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border-color); }
        .admin-table th { color: var(--primary-light); }
        .admin-table img { width: 50px; height: 50px; object-fit: cover; border-radius: 5px; }
        .actions-cell button { background: none; border: none; font-size: 1rem; margin-right: 10px; }
        .btn-edit { color: var(--primary-light); }
        .btn-archive { color: #ffc107; }
        .btn-delete { color: var(--danger-color); }
        .btn-restore { color: var(--success-color); }
        .archived-item { opacity: 0.5; text-decoration: line-through; }

        /* --- RESPONSIVE STYLES --- */
        @media (max-width: 992px) {
            .admin-container { flex-direction: column; }
            .admin-sidebar { width: 100%; margin-bottom: 30px; }
        }
        @media (max-width: 768px) {
            .admin-menu { display: flex; flex-wrap: wrap; gap: 10px; }
            .admin-menu li { flex-grow: 1; }
            .admin-menu li a { text-align: center; }
        }
        @media (max-width: 480px) {
            .admin-table { display: block; width: 100%; }
            .admin-table thead, .admin-table tbody, .admin-table tr, .admin-table th, .admin-table td { display: block; }
            .admin-table thead { display: none; }
            .admin-table tr { border: 1px solid var(--border-color); border-radius: 10px; margin-bottom: 15px; }
            .admin-table td { border: none; border-bottom: 1px solid var(--border-color); position: relative; padding-left: 50%; }
            .admin-table td:before { position: absolute; left: 10px; width: 45%; padding-right: 10px; white-space: nowrap; content: attr(data-label); font-weight: bold; color: var(--primary-light); }
            .admin-table td:last-child { border-bottom: none; }
        }
    </style>
</head>
<body>

    <div id="admin-panel" class="container">
        <div class="admin-container">
            <aside class="admin-sidebar">
                <h2>Admin Panel</h2>
                <ul class="admin-menu">
                    <li><a href="#" data-view="dashboard" class="active"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                    <li><a href="#" data-view="hero"><i class="fas fa-image"></i> Hero Section</a></li>
                    <li><a href="#" data-view="categories"><i class="fas fa-tags"></i> Categories</a></li>
                    <li><a href="#" data-view="products"><i class="fas fa-wine-bottle"></i> Products</a></li>
                    <li><a href="/index.html" id="exit-admin-mode"><i class="fas fa-sign-out-alt"></i> Exit Admin Mode</a></li>
                </ul>
            </aside>

            <main class="admin-main-content">
                <div id="admin-view-dashboard" class="admin-view active">
                    <h3>Welcome, Administrator!</h3>
                    <p>Select a section from the menu to start managing your website content.</p>
                </div>
                <div id="admin-view-hero" class="admin-view">
                    <h3>Edit Hero Section</h3>
                    <form id="hero-form">
                        <div class="form-group"><label for="hero-subtitle">Subtitle</label><input type="text" id="hero-subtitle" name="heroSubtitle"></div>
                        <div class="form-group"><label for="hero-title">Title</label><input type="text" id="hero-title" name="heroTitle"></div>
                        <div class="form-group"><label for="hero-description">Description</label><textarea id="hero-description" name="heroDescription"></textarea></div>
                        <div class="form-group"><label for="hero-bg-image">Background Image URL</label><input type="text" id="hero-bg-image" name="heroBgImage"></div>
                        <h4>SEO Settings for Main Page</h4>
                        <div class="form-group"><label for="hero-meta-title">Meta Title</label><input type="text" id="hero-meta-title" name="metaTitle"></div>
                        <div class="form-group"><label for="hero-meta-description">Meta Description</label><textarea id="hero-meta-description" name="metaDescription"></textarea></div>
                        <button type="submit" class="btn-save">Save Changes</button>
                    </form>
                </div>
                <div id="admin-view-categories" class="admin-view">
                    <h3>Manage Categories</h3>
                    <button id="btn-add-category" class="btn-add-new"><i class="fas fa-plus"></i> Add New Category</button>
                    <div id="category-form-container" style="display: none;">
                        <form id="category-form">
                            <input type="hidden" id="category-id" name="id">
                            <div class="form-group"><label for="category-name">Category Name</label><input type="text" id="category-name" name="name" required></div>
                            <div class="form-group"><label for="category-slug">URL Slug</label><input type="text" id="category-slug" name="slug" required><small>e.g., "Red Wine" -> "red-wine".</small></div>
                            <div class="form-group"><label for="category-image">Image URL</label><input type="text" id="category-image" name="imageUrl" required></div>
                            <div class="form-group"><label for="category-product-count">Product Count</label><input type="number" id="category-product-count" name="productCount" required></div>
                            <button type="submit" class="btn-save">Save Category</button>
                        </form>
                        <hr style="margin: 20px 0; border-color: var(--border-color);">
                    </div>
                    <table class="admin-table">
                        <thead><tr><th>Image</th><th>Name</th><th>Slug</th><th>Status</th><th>Actions</th></tr></thead>
                        <tbody id="categories-table-body"></tbody>
                    </table>
                </div>
                <div id="admin-view-products" class="admin-view">
                    <h3>Manage Products</h3>
                    <button id="btn-add-product" class="btn-add-new"><i class="fas fa-plus"></i> Add New Product</button>
                    <div id="product-form-container" style="display: none;">
                        <form id="product-form">
                            <input type="hidden" id="product-id" name="id">
                            <h4>Main Information</h4>
                            <div class="form-group"><label for="product-name">Product Name</label><input type="text" id="product-name" name="name" required></div>
                            <div class="form-group"><label for="product-slug">URL Slug</label><input type="text" id="product-slug" name="slug" required></div>
                            <div class="form-group"><label for="product-country">Country</label><input type="text" id="product-country" name="country" required></div>
                            <div class="form-group"><label for="product-region">Region</label><input type="text" id="product-region" name="region" required></div>
                            <div class="form-group"><label for="product-appellation">Appellation</label><input type="text" id="product-appellation" name="appellation"></div>
                            <div class="form-group"><label for="product-year">Year</label><input type="number" id="product-year" name="year"></div>
                            <div class="form-group"><label for="product-grape-varieties">Grape Varieties</label><input type="text" id="product-grape-varieties" name="grapeVarieties"></div>
                            <div class="form-group"><label for="product-sweetness">Sweetness</label><select id="product-sweetness" name="sweetness"><option value="">-- Select --</option><optgroup label="Still Wines"><option value="Dry">Dry</option><option value="Semi-Dry">Semi-Dry</option><option value="Semi-Sweet">Semi-Sweet</option><option value="Sweet">Sweet</option></optgroup><optgroup label="Sparkling Wines"><option value="Brut Nature">Brut Nature</option><option value="Extra Brut">Extra Brut</option><option value="Brut">Brut</option><option value="Extra-Dry">Extra-Dry</option><option value="Dry / Sec">Dry / Sec</option><option value="Demi-Sec">Demi-Sec</option><option value="Doux">Doux</option></optgroup></select></div>
                            <div class="form-group"><label for="product-alcohol">Alcohol %</label><input type="number" id="product-alcohol" name="alcohol" step="0.1"></div>
                            <div class="form-group"><label for="product-volume">Volume</label><select id="product-volume" name="volume"><option value="0.375L">0.375L</option><option value="0.75L">0.75L</option><option value="1.5L">1.5L</option></select></div>
                            <div class="form-group"><label for="product-category">Category</label><select id="product-category" name="category" required></select></div>
                            <div class="form-group"><label for="product-image-urls">Image URLs (one per line)</label><textarea id="product-image-urls" name="imageUrls" required rows="4"></textarea></div>
                            <div class="form-group"><label for="product-description">Description</label><textarea id="product-description" name="description"></textarea></div>
                            <div class="form-group"><label for="product-price">Price</label><input type="number" id="product-price" name="price" step="0.01" required></div>
                            <div class="form-group"><label for="product-old-price">Old Price</label><input type="number" id="product-old-price" name="oldPrice" step="0.01"></div>
                            <div class="form-group"><label for="product-badge">Badge</label><input type="text" id="product-badge" name="badge"></div>
                            <div class="form-group"><label for="product-stock-status">Stock Status</label><select id="product-stock-status" name="stockStatus"><option value="In Stock">In Stock</option><option value="Low Stock">Low Stock</option><option value="Out of Stock">Out of Stock</option></select></div>
                            <h4>Wine Details</h4>
                            <div class="form-group"><label for="product-tasting-notes">Tasting Notes</label><textarea id="product-tasting-notes" name="tastingNotes"></textarea></div>
                            <div class="form-group"><label for="product-food-pairing">Food Pairing</label><textarea id="product-food-pairing" name="foodPairing"></textarea></div>
                            <div class="form-group"><label for="product-serving">Serving Recommendations</label><textarea id="product-serving" name="serving"></textarea></div>
                            <hr style="margin: 30px 0; border-color: var(--border-color);">
                            <h4>SEO & Schema Markup</h4>
                            <div class="form-group"><label for="product-meta-title">Meta Title</label><input type="text" id="product-meta-title" name="metaTitle"></div>
                            <div class="form-group"><label for="product-meta-description">Meta Description</label><textarea id="product-meta-description" name="metaDescription"></textarea></div>
                            <div class="form-group"><label for="product-sku">SKU</label><input type="text" id="product-sku" name="sku"></div>
                            <div class="form-group"><label for="product-brand">Producer / Winery</label><input type="text" id="product-brand" name="brand"></div>
                            <div class="form-group"><label for="product-gtin">GTIN</label><input type="text" id="product-gtin" name="gtin"></div>
                            <div class="form-group"><label for="product-rating-value">Average Rating (1-5)</label><input type="number" id="product-rating-value" name="ratingValue" step="0.1" min="1" max="5"></div>
                            <div class="form-group"><label for="product-review-count">Number of Reviews</label><input type="number" id="product-review-count" name="reviewCount" step="1" min="0"></div>
                            <button type="submit" class="btn-save">Save Product</button>
                        </form>
                        <hr style="margin: 20px 0; border-color: var(--border-color);">
                    </div>
                    <table class="admin-table">
                        <thead><tr><th>Image</th><th>Name</th><th>Price</th><th>Status</th><th>Actions</th></tr></thead>
                        <tbody id="products-table-body"></tbody>
                    </table>
                </div>
            </main>
        </div>
    </div>

    <script type="module">
    // ===============================================================
    // =================== FIREBASE INITIALIZATION ===================
    // ===============================================================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, getDoc, query, addDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBflzOWVf3HgDpdUhha3qvyeUJf7i6dOuk",
      authDomain: "wine-91d0e.firebaseapp.com",
      projectId: "wine-91d0e",
      storageBucket: "wine-91d0e.firebasestorage.app",
      messagingSenderId: "1021620433427",
      appId: "1:1021620433427:web:5439252fb350c4455a85e6",
      measurementId: "G-TRWHY3KXK1"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ===============================================================
    // =================== ADMIN PANEL SCRIPT ========================
    // ===============================================================
    document.addEventListener('DOMContentLoaded', () => {
        async function fetchHeroData() {
            const docSnap = await getDoc(doc(db, "siteContent", "hero"));
            return docSnap.exists() ? docSnap.data() : null;
        }
        async function fetchCategories() {
            const querySnapshot = await getDocs(query(collection(db, "categories")));
            return querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        }
        async function fetchProducts() {
            const querySnapshot = await getDocs(query(collection(db, "products")));
            return querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        }

        function initializeAdminPanel(initialData) {
            let localData = JSON.parse(JSON.stringify(initialData));

            const adminMenuLinks = document.querySelectorAll('.admin-menu a');
            const adminViews = document.querySelectorAll('.admin-view');

            adminMenuLinks.forEach(link => {
                link.addEventListener('click', e => {
                    e.preventDefault();
                    if (link.id === 'exit-admin-mode') {
                        window.location.href = '/index.html';
                        return;
                    }
                    const viewId = `admin-view-${link.dataset.view}`;
                    adminMenuLinks.forEach(l => l.classList.remove('active'));
                    link.classList.add('active');
                    adminViews.forEach(view => view.classList.remove('active'));
                    document.getElementById(viewId).classList.add('active');
                    switch (link.dataset.view) {
                        case 'hero': loadHeroAdmin(); break;
                        case 'categories': loadCategoriesAdmin(); break;
                        case 'products': loadProductsAdmin(); break;
                    }
                });
            });

            function generateSlug(text) {
                return text.toString().toLowerCase().replace(/\s+/g, '-').replace(/[^\w\-]+/g, '').replace(/\-\-+/g, '-').replace(/^-+/, '').replace(/-+$/, '');
            }

            const heroForm = document.getElementById('hero-form');
            function loadHeroAdmin() {
                heroForm.heroSubtitle.value = localData.hero.heroSubtitle || '';
                heroForm.heroTitle.value = localData.hero.heroTitle || '';
                heroForm.heroDescription.value = localData.hero.heroDescription || '';
                heroForm.heroBgImage.value = localData.hero.heroBgImage || '';
                heroForm.metaTitle.value = localData.hero.metaTitle || '';
                heroForm.metaDescription.value = localData.hero.metaDescription || '';
            }
            heroForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const updatedData = {
                    heroSubtitle: heroForm.heroSubtitle.value,
                    heroTitle: heroForm.heroTitle.value,
                    heroDescription: heroForm.heroDescription.value,
                    heroBgImage: heroForm.heroBgImage.value,
                    metaTitle: heroForm.metaTitle.value,
                    metaDescription: heroForm.metaDescription.value,
                };
                try {
                    await updateDoc(doc(db, "siteContent", "hero"), updatedData);
                    localData.hero = updatedData;
                    alert('Hero section updated!');
                } catch (error) {
                    alert('Error updating hero section.');
                }
            });

            const categoryFormContainer = document.getElementById('category-form-container');
            const categoryForm = document.getElementById('category-form');
            const categoriesTableBody = document.getElementById('categories-table-body');
            document.getElementById('category-name').addEventListener('input', (e) => {
                document.getElementById('category-slug').value = generateSlug(e.target.value);
            });
            document.getElementById('btn-add-category').addEventListener('click', () => {
                categoryForm.reset();
                categoryForm['category-id'].value = '';
                categoryFormContainer.style.display = 'block';
            });

            function loadCategoriesAdmin() {
                categoriesTableBody.innerHTML = '';
                localData.categories.forEach(cat => {
                    const row = document.createElement('tr');
                    if (cat.isArchived) row.classList.add('archived-item');
                    row.innerHTML = `<td data-label="Image"><img src="${cat.imageUrl}" alt="${cat.name}"></td><td data-label="Name">${cat.name}</td><td data-label="Slug">${cat.slug || 'N/A'}</td><td data-label="Status">${cat.isArchived ? 'Archived' : 'Active'}</td><td data-label="Actions" class="actions-cell"><button class="btn-edit" data-id="${cat.id}"><i class="fas fa-edit"></i></button><button class="${cat.isArchived ? 'btn-restore' : 'btn-archive'}" data-id="${cat.id}"><i class="fas ${cat.isArchived ? 'fa-undo' : 'fa-archive'}"></i></button><button class="btn-delete" data-id="${cat.id}"><i class="fas fa-trash"></i></button></td>`;
                    categoriesTableBody.appendChild(row);
                });
            }

            categoryForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = categoryForm['category-id'].value;
                const formData = { name: categoryForm['category-name'].value, slug: categoryForm['category-slug'].value, imageUrl: categoryForm['category-image'].value, productCount: parseInt(categoryForm['category-product-count'].value) };
                try {
                    if (id) {
                        await updateDoc(doc(db, "categories", id), formData);
                        const index = localData.categories.findIndex(c => c.id === id);
                        localData.categories[index] = { ...localData.categories[index], ...formData };
                    } else {
                        const docRef = await addDoc(collection(db, "categories"), { ...formData, isArchived: false });
                        localData.categories.push({ id: docRef.id, ...formData, isArchived: false });
                    }
                    categoryForm.reset();
                    categoryFormContainer.style.display = 'none';
                    loadCategoriesAdmin();
                    alert('Category saved!');
                } catch (error) {
                    alert('Error saving category.');
                }
            });

            categoriesTableBody.addEventListener('click', async (e) => {
                const target = e.target.closest('button');
                if (!target) return;
                const id = target.dataset.id;
                const category = localData.categories.find(c => c.id === id);
                if (target.classList.contains('btn-edit')) {
                    categoryForm['category-id'].value = category.id;
                    categoryForm['category-name'].value = category.name;
                    categoryForm['category-slug'].value = category.slug || '';
                    categoryForm['category-image'].value = category.imageUrl;
                    categoryForm['category-product-count'].value = category.productCount;
                    categoryFormContainer.style.display = 'block';
                } else if (target.classList.contains('btn-archive') || target.classList.contains('btn-restore')) {
                    const newStatus = !category.isArchived;
                    await updateDoc(doc(db, "categories", id), { isArchived: newStatus });
                    category.isArchived = newStatus;
                    loadCategoriesAdmin();
                } else if (target.classList.contains('btn-delete')) {
                    if (confirm('Are you sure?')) {
                        await deleteDoc(doc(db, "categories", id));
                        localData.categories = localData.categories.filter(c => c.id !== id);
                        loadCategoriesAdmin();
                    }
                }
            });

            const productFormContainer = document.getElementById('product-form-container');
            const productForm = document.getElementById('product-form');
            const productsTableBody = document.getElementById('products-table-body');
            const productCategorySelect = document.getElementById('product-category');
            document.getElementById('product-name').addEventListener('input', (e) => {
                document.getElementById('product-slug').value = generateSlug(e.target.value);
            });
            function populateCategorySelect() {
                productCategorySelect.innerHTML = localData.categories.filter(c => !c.isArchived).map(c => `<option value="${c.name}">${c.name}</option>`).join('');
            }
            document.getElementById('btn-add-product').addEventListener('click', () => {
                productForm.reset();
                productForm['product-id'].value = '';
                populateCategorySelect();
                productFormContainer.style.display = 'block';
            });

            function loadProductsAdmin() {
                productsTableBody.innerHTML = '';
                localData.products.forEach(prod => {
                    const row = document.createElement('tr');
                    if (prod.isArchived) row.classList.add('archived-item');
                    const displayImage = (prod.imageUrls && prod.imageUrls.length > 0) ? prod.imageUrls[0] : prod.imageUrl;
                    row.innerHTML = `<td data-label="Image"><img src="${displayImage}" alt="${prod.name}"></td><td data-label="Name">${prod.name}</td><td data-label="Price">$${prod.price.toFixed(2)}</td><td data-label="Status">${prod.isArchived ? 'Archived' : 'Active'}</td><td data-label="Actions" class="actions-cell"><button class="btn-edit" data-id="${prod.id}"><i class="fas fa-edit"></i></button><button class="${prod.isArchived ? 'btn-restore' : 'btn-archive'}" data-id="${prod.id}"><i class="fas ${prod.isArchived ? 'fa-undo' : 'fa-archive'}"></i></button><button class="btn-delete" data-id="${prod.id}"><i class="fas fa-trash"></i></button></td>`;
                    productsTableBody.appendChild(row);
                });
            }

            productForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = productForm['product-id'].value;
                const imageUrls = productForm.imageUrls.value.split('\n').map(url => url.trim()).filter(url => url);
                const formData = {
                    name: productForm.name.value, slug: productForm.slug.value, region: productForm.region.value, country: productForm.country.value, appellation: productForm.appellation.value, year: parseInt(productForm.year.value) || null, grapeVarieties: productForm.grapeVarieties.value, sweetness: productForm.sweetness.value, alcohol: parseFloat(productForm.alcohol.value) || null, volume: productForm.volume.value, category: productForm.category.value, imageUrl: imageUrls.length > 0 ? imageUrls[0] : '', imageUrls: imageUrls, description: productForm.description.value, price: parseFloat(productForm.price.value), oldPrice: parseFloat(productForm.oldPrice.value) || null, badge: productForm.badge.value, stockStatus: productForm.stockStatus.value, tastingNotes: productForm.tastingNotes.value, foodPairing: productForm.foodPairing.value, serving: productForm.serving.value, metaTitle: productForm.metaTitle.value, metaDescription: productForm.metaDescription.value, sku: productForm.sku.value, brand: productForm.brand.value, gtin: productForm.gtin.value, ratingValue: parseFloat(productForm.ratingValue.value) || null, reviewCount: parseInt(productForm.reviewCount.value) || null,
                };
                try {
                    if (id) {
                        await updateDoc(doc(db, "products", id), formData);
                        const index = localData.products.findIndex(p => p.id === id);
                        localData.products[index] = { ...localData.products[index], ...formData };
                    } else {
                        const docRef = await addDoc(collection(db, "products"), { ...formData, isArchived: false });
                        localData.products.push({ id: docRef.id, ...formData, isArchived: false });
                    }
                    productForm.reset();
                    productFormContainer.style.display = 'none';
                    loadProductsAdmin();
                    alert('Product saved!');
                } catch (error) {
                    alert('Error saving product.');
                }
            });

            productsTableBody.addEventListener('click', async (e) => {
                const target = e.target.closest('button');
                if (!target) return;
                const id = target.dataset.id;
                const product = localData.products.find(p => p.id === id);
                if (target.classList.contains('btn-edit')) {
                    populateCategorySelect();
                    Object.keys(product).forEach(key => {
                        if (productForm[key]) {
                            if (key === 'imageUrls') {
                                productForm[key].value = (product[key] && product[key].length > 0) ? product[key].join('\n') : '';
                            } else {
                                productForm[key].value = product[key] || '';
                            }
                        }
                    });
                    productForm['product-id'].value = product.id;
                    productFormContainer.style.display = 'block';
                } else if (target.classList.contains('btn-archive') || target.classList.contains('btn-restore')) {
                    const newStatus = !product.isArchived;
                    await updateDoc(doc(db, "products", id), { isArchived: newStatus });
                    product.isArchived = newStatus;
                    loadProductsAdmin();
                } else if (target.classList.contains('btn-delete')) {
                    if (confirm('Are you sure?')) {
                        await deleteDoc(doc(db, "products", id));
                        localData.products = localData.products.filter(p => p.id !== id);
                        loadProductsAdmin();
                    }
                }
            });
        }

        async function main() {
            try {
                const [hero, categories, products] = await Promise.all([fetchHeroData(), fetchCategories(), fetchProducts()]);
                initializeAdminPanel({ hero, categories, products });
            } catch (error) {
                console.error("Error initializing admin panel: ", error);
                document.body.innerHTML = `<div style="padding: 40px; text-align: center;"><h1>Error loading admin data.</h1><p>${error.message}</p></div>`;
            }
        }
        main();
    });
    </script>
</body>
</html>