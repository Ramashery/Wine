<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Catalog Debug Page</title>
    <style>
        body { font-family: sans-serif; background-color: #f0f0f0; }
        #status { font-size: 1.5em; font-weight: bold; margin-bottom: 20px; }
        #error-details { color: red; background-color: #ffe0e0; border: 1px solid red; padding: 10px; white-space: pre-wrap; }
        #products-grid { border: 2px dashed #ccc; padding: 10px; min-height: 50px; }
        .product-card { border: 1px solid #000; padding: 10px; margin: 5px; background-color: #fff; }
    </style>
</head>
<body>

    <h1>Catalog Logic Debugger</h1>
    <div id="status">Loading products...</div>
    <div id="error-details" style="display: none;"></div>
    
    <h2>Rendered Products Grid:</h2>
    <div id="products-grid"></div>

    <!-- Эти пустые div'ы нужны, чтобы скрипт не выдавал ошибок "element not found" -->
    <div id="loader" style="display: none;"></div>
    <div id="main-site-content"></div>
    <div class="products-count"></div>
    <button id="load-more-btn"></button>

    <!-- ТОТ ЖЕ САМЫЙ СКРИПТ ИЗ CATALOG.HTML, НО С УЛУЧШЕННОЙ ДИАГНОСТИКОЙ ОШИБОК -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        // КОНФИГУРАЦИЯ 1-В-1 ИЗ ВАШЕГО ФАЙЛА
        const firebaseConfig = {
          apiKey: "AIzaSyBflzOWVf3HgDpdUhha3qvyeUJf7i6dOuk",
          authDomain: "wine-91d0e.firebaseapp.com",
          projectId: "wine-91d0e",
          storageBucket: "wine-91d0e.firebasestorage.app",
          messagingSenderId: "1021620433427",
          appId: "1:1021620433427:web:5439252fb350c4455a85e6",
          measurementId: "G-TRWHY3KXK1"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Получаем ссылки на наши простые HTML элементы
        const statusDiv = document.getElementById('status');
        const errorDiv = document.getElementById('error-details');
        const productsGrid = document.getElementById('products-grid');

        // ======== ОСНОВНАЯ ЛОГИКА ИЗ CATALOG.HTML ========
        // Мы берем только самую суть, отвечающую за загрузку и отрисовку

        let allProducts = [];

        async function fetchProductsAndInit() {
            try {
                statusDiv.textContent = "Attempting to query products with filter (where isArchived == false)...";
                console.log("Attempting query...");

                const productsQuery = query(collection(db, "products"), where("isArchived", "==", false));
                const productsSnapshot = await getDocs(productsQuery);
                
                statusDiv.textContent = `Query successful! Found ${productsSnapshot.docs.length} products.`;
                console.log(`Query successful! Found ${productsSnapshot.docs.length} products.`);

                allProducts = productsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // Упрощенная отрисовка для теста
                renderProducts();

            } catch (error) {
                // Если произойдет ЛЮБАЯ ошибка, мы выведем ее на экран
                console.error("CRITICAL ERROR IN SCRIPT: ", error);
                statusDiv.textContent = "ERROR! The script failed to run.";
                statusDiv.style.color = 'red';
                errorDiv.textContent = `Error Name: ${error.name}\n\nError Message: ${error.message}\n\nStack Trace:\n${error.stack}`;
                errorDiv.style.display = 'block';
            } finally {
                // Упрощенная логика, просто для лога
                console.log("Script execution finished (finally block).");
            }
        }

        function renderProducts() {
            if (allProducts.length === 0) {
                productsGrid.innerHTML = '<p>No products match the criteria. The grid is empty.</p>';
                return;
            }

            allProducts.forEach(prod => {
                const card = document.createElement('div');
                card.className = 'product-card';
                // Проверяем наличие ключевых полей, чтобы избежать ошибок
                const name = prod.name || 'Unnamed Product';
                const price = prod.price !== undefined ? `$${prod.price}` : 'No price';
                card.innerHTML = `<strong>${name}</strong><br>Price: ${price}<br>ID: ${prod.id}`;
                productsGrid.appendChild(card);
            });
            statusDiv.textContent += " Rendered successfully!";
            statusDiv.style.color = 'green';
        }

        // Запускаем процесс
        fetchProductsAndInit();
    </script>
</body>
</html>